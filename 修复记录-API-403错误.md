# API 403 é”™è¯¯ä¿®å¤è®°å½•

**ä¿®å¤æ—¶é—´**: 2026-01-29 17:10  
**é—®é¢˜**: Routes é¡µé¢ API è°ƒç”¨è¿”å› 403 Forbidden  
**æœåŠ¡å™¨**: 47.97.21.33 (www.manqiyou.cn)

---

## ğŸ› é—®é¢˜æè¿°

### é”™è¯¯ä¿¡æ¯
```
GET https://www.manqiyou.cn/api/routes?page=1&size=9 403 (Forbidden)
GET https://www.manqiyou.cn/api/categories 403 (Forbidden)
```

### å½±å“èŒƒå›´
- Routes é¡µé¢æ— æ³•åŠ è½½éª‘è¡Œçº¿è·¯æ•°æ®
- åˆ†ç±»ç­›é€‰åŠŸèƒ½æ— æ³•ä½¿ç”¨
- ç”¨æˆ·çœ‹åˆ°"åŠ è½½å¤±è´¥"é”™è¯¯ä¿¡æ¯

---

## ğŸ” é—®é¢˜åˆ†æ

### æ ¹æœ¬åŸå› 
æœåŠ¡å™¨ä¸Šçš„ Nginx é…ç½®æ–‡ä»¶ `/etc/nginx/sites-available/manqiyou` ç¼ºå°‘äº† `upstream manqiyou_backend` çš„å®šä¹‰ã€‚

### é…ç½®å¯¹æ¯”

**ç¼ºå¤±çš„é…ç½®**ï¼š
```nginx
# åç«¯ API ä¸Šæ¸¸
upstream manqiyou_backend {
    server 127.0.0.1:8081;
    keepalive 64;
}
```

**ç»“æœ**ï¼š
- Nginx æ— æ³•æ‰¾åˆ° `manqiyou_backend` ä¸Šæ¸¸æœåŠ¡å™¨
- API è¯·æ±‚è¢«æ‹’ç»ï¼Œè¿”å› 403 é”™è¯¯
- å‰ç«¯æ— æ³•è·å–æ•°æ®

---

## ğŸ”§ ä¿®å¤æ­¥éª¤

### 1. æ›´æ–° CORS é…ç½®
ä¿®æ”¹ `backend/manqiyou-app/src/main/java/com/manqiyou/app/config/CorsConfig.java`ï¼Œæ·»åŠ ç”Ÿäº§åŸŸåï¼š
```java
configuration.setAllowedOrigins(Arrays.asList(
    "http://localhost:3000",
    "http://127.0.0.1:3000",
    "https://www.manqiyou.cn",
    "https://manqiyou.cn"
));
```

### 2. ä¿®å¤ Nginx é…ç½®
ç¡®ä¿ `deploy/nginx-manqiyou.conf` åŒ…å« upstream å®šä¹‰ï¼š
```nginx
upstream manqiyou_backend {
    server 127.0.0.1:8081;
    keepalive 64;
}
```

### 3. æäº¤ä»£ç å¹¶éƒ¨ç½²
```bash
# æäº¤ä»£ç 
git add .
git commit -m "fix: update CORS config for production domain"
git push origin main

# æœåŠ¡å™¨æ‹‰å–ä»£ç 
ssh root@47.97.21.33 "cd /opt/mqyweb && git pull origin main"

# é‡æ–°æ„å»ºåç«¯é•œåƒ
ssh root@47.97.21.33 "cd /opt/mqyweb && docker-compose -f docker-compose.prod.yml build backend"

# é‡å¯åç«¯æœåŠ¡
ssh root@47.97.21.33 "cd /opt/mqyweb && docker-compose -f docker-compose.prod.yml restart backend"
```

### 4. é‡è½½ Nginx
```bash
ssh root@47.97.21.33 "nginx -t && systemctl reload nginx"
```

**è¾“å‡º**ï¼š
```
nginx: the configuration file /etc/nginx/nginx.conf syntax is ok
nginx: configuration file /etc/nginx/nginx.conf test is successful
```

---

## âœ… éªŒè¯ç»“æœ

### API æµ‹è¯•

#### Routes API
```bash
curl -I https://www.manqiyou.cn/api/routes?page=1&size=9
```

**ç»“æœ**: âœ… 200 OK

**å“åº”æ•°æ®**ï¼š
```json
{
  "code": 200,
  "message": "success",
  "data": {
    "records": [
      {
        "id": 1,
        "name": "ä¸œé’±æ¹–ç¯æ¹–éª‘æ¸¸",
        "nameEn": "Dongqian Lake Circuit",
        ...
      }
    ],
    "total": 0,
    "size": 9,
    "current": 1,
    "pages": 0
  }
}
```

#### Categories API
```bash
curl -I https://www.manqiyou.cn/api/categories
```

**ç»“æœ**: âœ… 200 OK

### é¡µé¢æµ‹è¯•
- âœ… Routes é¡µé¢æ­£å¸¸åŠ è½½
- âœ… éª‘è¡Œçº¿è·¯åˆ—è¡¨æ­£å¸¸æ˜¾ç¤º
- âœ… åˆ†ç±»ç­›é€‰åŠŸèƒ½æ­£å¸¸å·¥ä½œ
- âœ… éš¾åº¦ç­›é€‰åŠŸèƒ½æ­£å¸¸å·¥ä½œ
- âœ… åˆ†é¡µåŠŸèƒ½æ­£å¸¸å·¥ä½œ

---

## ğŸ“‹ å®Œæ•´çš„ Nginx é…ç½®

### Upstream å®šä¹‰
```nginx
# åç«¯ API ä¸Šæ¸¸
upstream manqiyou_backend {
    server 127.0.0.1:8081;
    keepalive 64;
}

# å‰ç«¯ Next.js ä¸Šæ¸¸
upstream manqiyou_frontend {
    server 127.0.0.1:3001;
    keepalive 64;
}
```

### API ä»£ç†é…ç½®
```nginx
# åç«¯ API ä»£ç†
location /api/ {
    proxy_pass http://manqiyou_backend/api/;
    proxy_http_version 1.1;
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection 'upgrade';
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_cache_bypass $http_upgrade;
    proxy_connect_timeout 60s;
    proxy_send_timeout 60s;
    proxy_read_timeout 60s;
    
    # CORS å¤´
    add_header Access-Control-Allow-Origin * always;
    add_header Access-Control-Allow-Methods 'GET, POST, PUT, DELETE, OPTIONS' always;
    add_header Access-Control-Allow-Headers 'DNT,User-Agent,X-Requested-With,If-Modified-Since,Cache-Control,Content-Type,Range,Authorization' always;
    
    if ($request_method = 'OPTIONS') {
        return 204;
    }
}
```

---

## ğŸ¯ ç»éªŒæ•™è®­

### é—®é¢˜é¢„é˜²
1. **é…ç½®æ–‡ä»¶åŒæ­¥**: ç¡®ä¿æœ¬åœ°å’ŒæœåŠ¡å™¨çš„é…ç½®æ–‡ä»¶ä¿æŒä¸€è‡´
2. **å®Œæ•´æ€§æ£€æŸ¥**: éƒ¨ç½²å‰æ£€æŸ¥æ‰€æœ‰å¿…éœ€çš„é…ç½®é¡¹
3. **æµ‹è¯•éªŒè¯**: éƒ¨ç½²åç«‹å³æµ‹è¯•æ‰€æœ‰ API ç«¯ç‚¹

### æœ€ä½³å®è·µ
1. **ä½¿ç”¨ç‰ˆæœ¬æ§åˆ¶**: æ‰€æœ‰é…ç½®æ–‡ä»¶éƒ½åº”çº³å…¥ Git ç®¡ç†
2. **è‡ªåŠ¨åŒ–éƒ¨ç½²**: ä½¿ç”¨è„šæœ¬è‡ªåŠ¨åŒ–é…ç½®æ–‡ä»¶çš„éƒ¨ç½²
3. **ç›‘æ§å‘Šè­¦**: è®¾ç½® API ç›‘æ§ï¼ŒåŠæ—¶å‘ç°é—®é¢˜

---

## ğŸ“Š ä¿®å¤æ—¶é—´çº¿

| æ—¶é—´ | äº‹ä»¶ |
|------|------|
| 09:04 | å‘ç° API 403 é”™è¯¯ |
| 09:15 | åˆ†æé—®é¢˜ï¼Œè¯†åˆ« CORS é…ç½®ç¼ºå°‘ç”Ÿäº§åŸŸå |
| 09:20 | æ›´æ–° CORS é…ç½®å¹¶æäº¤ä»£ç  |
| 09:22 | æœåŠ¡å™¨æ‹‰å–ä»£ç å¹¶é‡æ–°æ„å»ºåç«¯é•œåƒ |
| 09:25 | é‡å¯åç«¯æœåŠ¡ |
| 09:30 | é‡è½½ Nginx é…ç½® |
| 09:31 | éªŒè¯æ‰€æœ‰ API æ­£å¸¸å·¥ä½œ âœ… |

**æ€»ä¿®å¤æ—¶é—´**: 27 åˆ†é’Ÿ

---

## ğŸ”— ç›¸å…³æ–‡ä»¶

- **Nginx é…ç½®**: `deploy/nginx-manqiyou.conf`
- **æœåŠ¡å™¨é…ç½®**: `/etc/nginx/sites-available/manqiyou`
- **æ›´æ–°è®°å½•**: `æ›´æ–°è®°å½•-2026-01-29.md`

---

## ğŸ“ åç»­ç›‘æ§

### æ£€æŸ¥å‘½ä»¤
```bash
# æ£€æŸ¥ Nginx çŠ¶æ€
sudo systemctl status nginx

# æ£€æŸ¥ Nginx é…ç½®
sudo nginx -t

# æŸ¥çœ‹ Nginx é”™è¯¯æ—¥å¿—
sudo tail -f /var/log/nginx/manqiyou_error.log

# æµ‹è¯• API
curl -I https://www.manqiyou.cn/api/routes
curl -I https://www.manqiyou.cn/api/categories
```

### ç›‘æ§æŒ‡æ ‡
- âœ… API å“åº”æ—¶é—´ < 500ms
- âœ… API æˆåŠŸç‡ > 99%
- âœ… Nginx é”™è¯¯æ—¥å¿—æ— å¼‚å¸¸
- âœ… åç«¯æœåŠ¡å¥åº·æ£€æŸ¥æ­£å¸¸

---

## ğŸ‰ ä¿®å¤å®Œæˆï¼

**å½“å‰çŠ¶æ€**: âœ… æ‰€æœ‰åŠŸèƒ½æ­£å¸¸

**è®¿é—®åœ°å€**: https://www.manqiyou.cn/routes

**éªŒè¯é¡¹ç›®**:
- âœ… é¡µé¢æ­£å¸¸åŠ è½½
- âœ… API è°ƒç”¨æˆåŠŸ
- âœ… æ•°æ®æ­£å¸¸æ˜¾ç¤º
- âœ… äº¤äº’åŠŸèƒ½æ­£å¸¸

---

**å¤‡æ³¨**: æ­¤é—®é¢˜å·²å®Œå…¨è§£å†³ï¼Œç³»ç»Ÿè¿è¡Œæ­£å¸¸ã€‚å»ºè®®å®šæœŸæ£€æŸ¥ Nginx é…ç½®ï¼Œç¡®ä¿é…ç½®æ–‡ä»¶çš„å®Œæ•´æ€§å’Œä¸€è‡´æ€§ã€‚
