# æ¼«éª‘æ¸¸é¡¹ç›® - é˜¿é‡Œäº‘éƒ¨ç½²å®Œæ•´æ‰§è¡Œæ–¹æ¡ˆ

## ğŸ“‹ é¡¹ç›®æ¦‚å†µ

### é¡¹ç›®ä¿¡æ¯
- **é¡¹ç›®åç§°**: æ¼«éª‘æ¸¸å®˜æ–¹ç½‘ç«™ (Manqiyou)
- **Git ä»“åº“**: git@github.com:zhf186/mqyweb.git
- **æœåŠ¡å™¨ IP**: 47.37.21.33
- **åŸŸå**: www.manqiyou.cn
- **Web æœåŠ¡å™¨**: Nginx (å·²å®‰è£…ï¼Œæœ‰å…¶ä»–é¡¹ç›®è¿è¡Œä¸­)
- **å®¹å™¨åŒ–**: Docker (æœ¬æœºå’ŒæœåŠ¡å™¨å‡å·²å®‰è£…)

### æŠ€æœ¯æ ˆ
- **å‰ç«¯**: Next.js 14 + TypeScript + Tailwind CSS
- **åç«¯**: Spring Boot 3.2 + Java 17 + MyBatis-Plus
- **æ•°æ®åº“**: PostgreSQL 16 (ç”Ÿäº§) / H2 (å¼€å‘)
- **ç¼“å­˜**: Redis 7
- **è¿›ç¨‹ç®¡ç†**: PM2 (å‰ç«¯) + systemd (åç«¯)

### éƒ¨ç½²è¦æ±‚
1. âœ… ä½¿ç”¨ Docker å®¹å™¨åŒ–éƒ¨ç½²
2. âœ… é€šè¿‡ Git æ‹‰å–ä»£ç 
3. âœ… é…ç½® HTTPS å¹¶è‡ªåŠ¨ç»­æœŸ
4. âœ… ä¸å½±å“æœåŠ¡å™¨ç°æœ‰é¡¹ç›®
5. âœ… ä½¿ç”¨ Nginx åå‘ä»£ç†

---

## ğŸ¯ éƒ¨ç½²æ¶æ„

```
Internet
    â†“
Nginx (80/443) - åå‘ä»£ç†
    â†“
    â”œâ”€â†’ www.manqiyou.cn â†’ Next.js Frontend (Docker: 3000)
    â””â”€â†’ www.manqiyou.cn/api â†’ Spring Boot Backend (Docker: 8080)
            â†“
            â”œâ”€â†’ PostgreSQL (Docker: 5432)
            â””â”€â†’ Redis (Docker: 6379)
```

---

## ğŸ“¦ ç¬¬ä¸€é˜¶æ®µï¼šæœ¬åœ°å‡†å¤‡å·¥ä½œ

### 1.1 é¡¹ç›®ä»£ç å‡†å¤‡

```bash
# åœ¨æœ¬åœ° Windows æœºå™¨ä¸Šæ‰§è¡Œ

# 1. ç¡®ä¿æ‰€æœ‰ä»£ç å·²æäº¤åˆ° Git
cd C:\path\to\manqiyou
git status
git add .
git commit -m "å‡†å¤‡éƒ¨ç½²åˆ°é˜¿é‡Œäº‘"
git push origin main

# 2. ç¡®è®¤ Git ä»“åº“å¯è®¿é—®
# æµ‹è¯• SSH è¿æ¥
ssh -T git@github.com
```

### 1.2 åˆ›å»º Docker é…ç½®æ–‡ä»¶

åœ¨é¡¹ç›®æ ¹ç›®å½•åˆ›å»ºä»¥ä¸‹æ–‡ä»¶ï¼š

**`docker-compose.prod.yml`** (ç”Ÿäº§ç¯å¢ƒ Docker Compose é…ç½®)


---

## ğŸš€ ç¬¬äºŒé˜¶æ®µï¼šæœåŠ¡å™¨ç¯å¢ƒå‡†å¤‡

### 2.1 è¿æ¥åˆ°é˜¿é‡Œäº‘æœåŠ¡å™¨

```bash
# ä»æœ¬åœ° Windows è¿æ¥åˆ°æœåŠ¡å™¨
ssh root@47.37.21.33

# æˆ–ä½¿ç”¨æ™®é€šç”¨æˆ·
ssh your-username@47.37.21.33
```

### 2.2 æ£€æŸ¥ç°æœ‰ç¯å¢ƒ

```bash
# æ£€æŸ¥ Docker
docker --version
docker-compose --version

# æ£€æŸ¥ Nginx
nginx -v
systemctl status nginx

# æ£€æŸ¥ç°æœ‰é¡¹ç›®
ls -la /var/www/
ps aux | grep nginx

# æ£€æŸ¥ç«¯å£å ç”¨
sudo netstat -tulpn | grep -E ':(80|443|3000|8080|5432|6379)'
```

### 2.3 å®‰è£…å¿…è¦å·¥å…·ï¼ˆå¦‚æœç¼ºå¤±ï¼‰

```bash
# æ›´æ–°ç³»ç»Ÿ
sudo apt update && sudo apt upgrade -y

# å®‰è£… Gitï¼ˆå¦‚æœæœªå®‰è£…ï¼‰
sudo apt install -y git

# å®‰è£… Docker Composeï¼ˆå¦‚æœæœªå®‰è£…ï¼‰
sudo apt install -y docker-compose-plugin

# æˆ–ä½¿ç”¨ç‹¬ç«‹ç‰ˆæœ¬
sudo curl -L "https://github.com/docker/compose/releases/latest/download/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose
sudo chmod +x /usr/local/bin/docker-compose
```

### 2.4 é…ç½® SSH å¯†é’¥ï¼ˆç”¨äº Gitï¼‰

```bash
# ç”Ÿæˆ SSH å¯†é’¥ï¼ˆå¦‚æœæ²¡æœ‰ï¼‰
ssh-keygen -t ed25519 -C "your-email@example.com"

# æŸ¥çœ‹å…¬é’¥
cat ~/.ssh/id_ed25519.pub

# å°†å…¬é’¥æ·»åŠ åˆ° GitHub
# è®¿é—®: https://github.com/settings/keys
# ç‚¹å‡» "New SSH key"ï¼Œç²˜è´´å…¬é’¥å†…å®¹

# æµ‹è¯•è¿æ¥
ssh -T git@github.com
```

---

## ğŸ“¦ ç¬¬ä¸‰é˜¶æ®µï¼šéƒ¨ç½²é¡¹ç›®

### 3.1 å…‹éš†é¡¹ç›®ä»£ç 

```bash
# åˆ›å»ºé¡¹ç›®ç›®å½•
sudo mkdir -p /var/www/manqiyou
sudo chown -R $USER:$USER /var/www/manqiyou

# å…‹éš†ä»£ç 
cd /var/www/manqiyou
git clone git@github.com:zhf186/mqyweb.git .

# ç¡®è®¤ä»£ç å·²ä¸‹è½½
ls -la
```

### 3.2 é…ç½®ç¯å¢ƒå˜é‡

```bash
cd /var/www/manqiyou

# å¤åˆ¶ç¯å¢ƒå˜é‡æ¨¡æ¿
cp .env.production .env

# ç¼–è¾‘ç¯å¢ƒå˜é‡ï¼ˆä¿®æ”¹å¯†ç å’Œå¯†é’¥ï¼‰
nano .env
```

**ä¿®æ”¹ä»¥ä¸‹å†…å®¹ï¼š**
```bash
# æ•°æ®åº“å¯†ç ï¼ˆè¯·ä½¿ç”¨å¼ºå¯†ç ï¼‰
DB_PASSWORD=your_strong_db_password_here

# Redis å¯†ç ï¼ˆè¯·ä½¿ç”¨å¼ºå¯†ç ï¼‰
REDIS_PASSWORD=your_strong_redis_password_here

# JWT å¯†é’¥ï¼ˆä½¿ç”¨éšæœºå­—ç¬¦ä¸²ï¼‰
JWT_SECRET=$(openssl rand -base64 32)

# API URLï¼ˆå·²é…ç½®å¥½ï¼‰
NEXT_PUBLIC_API_URL=https://www.manqiyou.cn/api
```

ä¿å­˜å¹¶é€€å‡ºï¼ˆCtrl+X, Y, Enterï¼‰

### 3.3 æ„å»ºå¹¶å¯åŠ¨ Docker å®¹å™¨

```bash
cd /var/www/manqiyou

# åŠ è½½ç¯å¢ƒå˜é‡
export $(cat .env | xargs)

# æ„å»ºå¹¶å¯åŠ¨æ‰€æœ‰æœåŠ¡
docker-compose -f docker-compose.prod.yml up -d --build

# æŸ¥çœ‹æ„å»ºè¿›åº¦
docker-compose -f docker-compose.prod.yml logs -f
```

**é¢„è®¡æ„å»ºæ—¶é—´ï¼š**
- åç«¯æ„å»ºï¼š5-10 åˆ†é’Ÿ
- å‰ç«¯æ„å»ºï¼š3-5 åˆ†é’Ÿ
- æ€»è®¡ï¼š10-15 åˆ†é’Ÿ

### 3.4 éªŒè¯æœåŠ¡çŠ¶æ€

```bash
# æŸ¥çœ‹æ‰€æœ‰å®¹å™¨çŠ¶æ€
docker-compose -f docker-compose.prod.yml ps

# åº”è¯¥çœ‹åˆ° 4 ä¸ªå®¹å™¨è¿è¡Œä¸­ï¼š
# - manqiyou-postgres
# - manqiyou-redis
# - manqiyou-backend
# - manqiyou-frontend

# æ£€æŸ¥å¥åº·çŠ¶æ€
docker-compose -f docker-compose.prod.yml ps | grep healthy

# æµ‹è¯•åç«¯ API
curl http://localhost:8080/api/health

# æµ‹è¯•å‰ç«¯
curl http://localhost:3000
```

---

## ğŸŒ ç¬¬å››é˜¶æ®µï¼šé…ç½® Nginx åå‘ä»£ç†

### 4.1 å¤‡ä»½ç°æœ‰ Nginx é…ç½®

```bash
# å¤‡ä»½ç°æœ‰é…ç½®
sudo cp -r /etc/nginx/sites-available /etc/nginx/sites-available.backup.$(date +%Y%m%d)
sudo cp -r /etc/nginx/sites-enabled /etc/nginx/sites-enabled.backup.$(date +%Y%m%d)
```

### 4.2 åˆ›å»ºæ¼«éª‘æ¸¸ Nginx é…ç½®

```bash
# å¤åˆ¶é…ç½®æ–‡ä»¶
sudo cp /var/www/manqiyou/deploy/nginx-manqiyou.conf /etc/nginx/sites-available/manqiyou

# åˆ›å»ºè½¯é“¾æ¥å¯ç”¨ç«™ç‚¹
sudo ln -s /etc/nginx/sites-available/manqiyou /etc/nginx/sites-enabled/

# æµ‹è¯• Nginx é…ç½®
sudo nginx -t
```

**å¦‚æœæµ‹è¯•å¤±è´¥ï¼Œæ£€æŸ¥ï¼š**
1. é…ç½®æ–‡ä»¶è¯­æ³•æ˜¯å¦æ­£ç¡®
2. ç«¯å£æ˜¯å¦è¢«å ç”¨
3. SSL è¯ä¹¦è·¯å¾„ï¼ˆæš‚æ—¶æ³¨é‡Šæ‰ SSL ç›¸å…³é…ç½®ï¼‰

### 4.3 ä¸´æ—¶é…ç½®ï¼ˆHTTP onlyï¼Œç”¨äºè·å– SSL è¯ä¹¦ï¼‰

```bash
# ç¼–è¾‘é…ç½®æ–‡ä»¶ï¼Œæš‚æ—¶æ³¨é‡Šæ‰ HTTPS éƒ¨åˆ†
sudo nano /etc/nginx/sites-available/manqiyou

# æ³¨é‡Šæ‰ 443 ç«¯å£çš„ server å—
# åªä¿ç•™ 80 ç«¯å£çš„é…ç½®ï¼Œå¹¶ä¿®æ”¹ä¸ºï¼š

server {
    listen 80;
    listen [::]:80;
    server_name www.manqiyou.cn manqiyou.cn;

    # Let's Encrypt éªŒè¯è·¯å¾„
    location /.well-known/acme-challenge/ {
        root /var/www/certbot;
    }

    # ä¸´æ—¶ä»£ç†åˆ°å‰ç«¯ï¼ˆç”¨äºæµ‹è¯•ï¼‰
    location / {
        proxy_pass http://127.0.0.1:3000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
    }

    # API ä»£ç†
    location /api/ {
        proxy_pass http://127.0.0.1:8080/api/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
    }
}
```

### 4.4 é‡è½½ Nginx

```bash
# æµ‹è¯•é…ç½®
sudo nginx -t

# é‡è½½ Nginx
sudo systemctl reload nginx

# æ£€æŸ¥çŠ¶æ€
sudo systemctl status nginx
```

### 4.5 æµ‹è¯• HTTP è®¿é—®

```bash
# ä»æœåŠ¡å™¨æœ¬åœ°æµ‹è¯•
curl http://www.manqiyou.cn

# ä»æœ¬åœ°æµè§ˆå™¨è®¿é—®
# http://www.manqiyou.cn
```

---

## ğŸ”’ ç¬¬äº”é˜¶æ®µï¼šé…ç½® HTTPS å’Œè‡ªåŠ¨ç»­æœŸ

### 5.1 ç¡®ä¿åŸŸåè§£ææ­£ç¡®

```bash
# æ£€æŸ¥åŸŸåè§£æ
nslookup www.manqiyou.cn
dig www.manqiyou.cn

# åº”è¯¥æŒ‡å‘ 47.37.21.33
```

### 5.2 åˆ›å»º Certbot ç›®å½•

```bash
sudo mkdir -p /var/www/certbot
sudo chown -R www-data:www-data /var/www/certbot
```

### 5.3 è·å– SSL è¯ä¹¦

```bash
cd /var/www/manqiyou/deploy

# ä¿®æ”¹é‚®ç®±åœ°å€
sudo nano setup-ssl.sh
# å°† your-email@example.com æ”¹ä¸ºä½ çš„å®é™…é‚®ç®±

# æ·»åŠ æ‰§è¡Œæƒé™
chmod +x setup-ssl.sh

# è¿è¡Œ SSL é…ç½®è„šæœ¬
sudo ./setup-ssl.sh
```

**è„šæœ¬ä¼šè‡ªåŠ¨ï¼š**
1. å®‰è£… Certbot
2. è·å– SSL è¯ä¹¦
3. é…ç½®è‡ªåŠ¨ç»­æœŸ
4. æµ‹è¯•ç»­æœŸåŠŸèƒ½

### 5.4 æ›´æ–° Nginx é…ç½®å¯ç”¨ HTTPS

```bash
# æ¢å¤å®Œæ•´çš„ Nginx é…ç½®ï¼ˆåŒ…å« HTTPSï¼‰
sudo cp /var/www/manqiyou/deploy/nginx-manqiyou.conf /etc/nginx/sites-available/manqiyou

# æµ‹è¯•é…ç½®
sudo nginx -t

# é‡è½½ Nginx
sudo systemctl reload nginx
```

### 5.5 éªŒè¯ HTTPS

```bash
# æµ‹è¯• HTTPS è®¿é—®
curl https://www.manqiyou.cn

# æ£€æŸ¥è¯ä¹¦ä¿¡æ¯
openssl s_client -connect www.manqiyou.cn:443 -servername www.manqiyou.cn < /dev/null

# ä»æµè§ˆå™¨è®¿é—®
# https://www.manqiyou.cn
```

### 5.6 é…ç½®è‡ªåŠ¨ç»­æœŸ

```bash
# æŸ¥çœ‹ certbot timer çŠ¶æ€
sudo systemctl status certbot.timer

# æŸ¥çœ‹ä¸‹æ¬¡ç»­æœŸæ—¶é—´
sudo certbot certificates

# æ‰‹åŠ¨æµ‹è¯•ç»­æœŸï¼ˆä¸ä¼šçœŸæ­£ç»­æœŸï¼‰
sudo certbot renew --dry-run
```

**è‡ªåŠ¨ç»­æœŸè¯´æ˜ï¼š**
- Certbot ä¼šæ¯å¤©æ£€æŸ¥ä¸¤æ¬¡è¯ä¹¦
- è¯ä¹¦åˆ°æœŸå‰ 30 å¤©è‡ªåŠ¨ç»­æœŸ
- ç»­æœŸåè‡ªåŠ¨é‡è½½ Nginx
- æ— éœ€äººå·¥å¹²é¢„

---

## âœ… ç¬¬å…­é˜¶æ®µï¼šéªŒè¯å’Œæµ‹è¯•

### 6.1 åŠŸèƒ½æµ‹è¯•æ¸…å•

```bash
# 1. æµ‹è¯•å‰ç«¯é¦–é¡µ
curl -I https://www.manqiyou.cn
# åº”è¿”å› 200 OK

# 2. æµ‹è¯•åç«¯ API
curl https://www.manqiyou.cn/api/health
# åº”è¿”å› {"status":"ok"}

# 3. æµ‹è¯•è·¯ç”±åˆ—è¡¨
curl https://www.manqiyou.cn/api/routes
# åº”è¿”å› JSON æ•°æ®

# 4. æµ‹è¯•é™æ€èµ„æº
curl -I https://www.manqiyou.cn/brand_assets/page1_img1.jpeg
# åº”è¿”å› 200 OK

# 5. æµ‹è¯• HTTPS é‡å®šå‘
curl -I http://www.manqiyou.cn
# åº”è¿”å› 301 é‡å®šå‘åˆ° HTTPS
```

### 6.2 æ€§èƒ½æµ‹è¯•

```bash
# å®‰è£…æµ‹è¯•å·¥å…·
sudo apt install -y apache2-utils

# å¹¶å‘æµ‹è¯•ï¼ˆ100 ä¸ªè¯·æ±‚ï¼Œ10 ä¸ªå¹¶å‘ï¼‰
ab -n 100 -c 10 https://www.manqiyou.cn/

# æŸ¥çœ‹å“åº”æ—¶é—´
curl -w "@-" -o /dev/null -s https://www.manqiyou.cn/ <<'EOF'
    time_namelookup:  %{time_namelookup}\n
       time_connect:  %{time_connect}\n
    time_appconnect:  %{time_appconnect}\n
      time_redirect:  %{time_redirect}\n
   time_starttransfer:  %{time_starttransfer}\n
                     ----------\n
         time_total:  %{time_total}\n
EOF
```

### 6.3 æµè§ˆå™¨æµ‹è¯•

åœ¨æµè§ˆå™¨ä¸­è®¿é—®ä»¥ä¸‹é¡µé¢ï¼š

1. **é¦–é¡µ**: https://www.manqiyou.cn
2. **å…³äºé¡µé¢**: https://www.manqiyou.cn/about
3. **è·¯çº¿é¡µé¢**: https://www.manqiyou.cn/routes
4. **E-BIKE é¡µé¢**: https://www.manqiyou.cn/ebike
5. **ç¤¾åŒºé¡µé¢**: https://www.manqiyou.cn/community
6. **åˆä½œä¼™ä¼´**: https://www.manqiyou.cn/partners
7. **å¥½ç‰©é¡µé¢**: https://www.manqiyou.cn/goods

**æ£€æŸ¥é¡¹ï¼š**
- [ ] é¡µé¢æ­£å¸¸åŠ è½½
- [ ] å›¾ç‰‡æ­£å¸¸æ˜¾ç¤º
- [ ] åŠ¨ç”»æ•ˆæœæ­£å¸¸
- [ ] ä¸­è‹±æ–‡åˆ‡æ¢æ­£å¸¸
- [ ] ç§»åŠ¨ç«¯å“åº”å¼æ­£å¸¸
- [ ] HTTPS é”å›¾æ ‡æ˜¾ç¤º
- [ ] æ— æ§åˆ¶å°é”™è¯¯

---

## ğŸ“Š ç¬¬ä¸ƒé˜¶æ®µï¼šç›‘æ§å’Œæ—¥å¿—

### 7.1 æŸ¥çœ‹ Docker å®¹å™¨æ—¥å¿—

```bash
cd /var/www/manqiyou

# æŸ¥çœ‹æ‰€æœ‰å®¹å™¨æ—¥å¿—
docker-compose -f docker-compose.prod.yml logs -f

# æŸ¥çœ‹ç‰¹å®šå®¹å™¨æ—¥å¿—
docker-compose -f docker-compose.prod.yml logs -f frontend
docker-compose -f docker-compose.prod.yml logs -f backend
docker-compose -f docker-compose.prod.yml logs -f postgres
docker-compose -f docker-compose.prod.yml logs -f redis

# æŸ¥çœ‹æœ€è¿‘ 100 è¡Œæ—¥å¿—
docker-compose -f docker-compose.prod.yml logs --tail=100
```

### 7.2 æŸ¥çœ‹ Nginx æ—¥å¿—

```bash
# è®¿é—®æ—¥å¿—
sudo tail -f /var/log/nginx/manqiyou_access.log

# é”™è¯¯æ—¥å¿—
sudo tail -f /var/log/nginx/manqiyou_error.log

# æŸ¥çœ‹æœ€è¿‘çš„é”™è¯¯
sudo tail -100 /var/log/nginx/manqiyou_error.log | grep error
```

### 7.3 ç³»ç»Ÿèµ„æºç›‘æ§

```bash
# å®‰è£…ç›‘æ§å·¥å…·
sudo apt install -y htop

# æŸ¥çœ‹ç³»ç»Ÿèµ„æº
htop

# æŸ¥çœ‹ Docker å®¹å™¨èµ„æºä½¿ç”¨
docker stats

# æŸ¥çœ‹ç£ç›˜ä½¿ç”¨
df -h

# æŸ¥çœ‹å†…å­˜ä½¿ç”¨
free -h
```

### 7.4 é…ç½®æ—¥å¿—è½®è½¬

```bash
# åˆ›å»ºæ—¥å¿—è½®è½¬é…ç½®
sudo tee /etc/logrotate.d/manqiyou << 'EOF'
/var/log/nginx/manqiyou_*.log {
    daily
    missingok
    rotate 14
    compress
    delaycompress
    notifempty
    create 0640 www-data adm
    sharedscripts
    postrotate
        [ -f /var/run/nginx.pid ] && kill -USR1 `cat /var/run/nginx.pid`
    endscript
}
EOF

# æµ‹è¯•æ—¥å¿—è½®è½¬
sudo logrotate -d /etc/logrotate.d/manqiyou
```

---

## ğŸ”„ ç¬¬å…«é˜¶æ®µï¼šæ—¥å¸¸è¿ç»´

### 8.1 æ›´æ–°ä»£ç 

```bash
cd /var/www/manqiyou

# æ‹‰å–æœ€æ–°ä»£ç 
git pull origin main

# é‡æ–°æ„å»ºå¹¶å¯åŠ¨
docker-compose -f docker-compose.prod.yml up -d --build

# æŸ¥çœ‹æ›´æ–°æ—¥å¿—
docker-compose -f docker-compose.prod.yml logs -f
```

### 8.2 é‡å¯æœåŠ¡

```bash
cd /var/www/manqiyou

# é‡å¯æ‰€æœ‰æœåŠ¡
docker-compose -f docker-compose.prod.yml restart

# é‡å¯ç‰¹å®šæœåŠ¡
docker-compose -f docker-compose.prod.yml restart frontend
docker-compose -f docker-compose.prod.yml restart backend

# é‡å¯ Nginx
sudo systemctl restart nginx
```

### 8.3 åœæ­¢æœåŠ¡

```bash
cd /var/www/manqiyou

# åœæ­¢æ‰€æœ‰æœåŠ¡
docker-compose -f docker-compose.prod.yml stop

# åœæ­¢å¹¶åˆ é™¤å®¹å™¨ï¼ˆä¿ç•™æ•°æ®ï¼‰
docker-compose -f docker-compose.prod.yml down

# åœæ­¢å¹¶åˆ é™¤å®¹å™¨å’Œæ•°æ®å·ï¼ˆå±é™©ï¼ï¼‰
docker-compose -f docker-compose.prod.yml down -v
```

### 8.4 æ•°æ®åº“å¤‡ä»½

```bash
# åˆ›å»ºå¤‡ä»½ç›®å½•
mkdir -p /var/www/manqiyou/backups

# å¤‡ä»½æ•°æ®åº“
docker exec manqiyou-postgres pg_dump -U manqiyou_user manqiyou > /var/www/manqiyou/backups/backup_$(date +%Y%m%d_%H%M%S).sql

# è‡ªåŠ¨å¤‡ä»½è„šæœ¬
cat > /var/www/manqiyou/backup.sh << 'EOF'
#!/bin/bash
BACKUP_DIR="/var/www/manqiyou/backups"
DATE=$(date +%Y%m%d_%H%M%S)
docker exec manqiyou-postgres pg_dump -U manqiyou_user manqiyou > $BACKUP_DIR/backup_$DATE.sql
# åˆ é™¤ 7 å¤©å‰çš„å¤‡ä»½
find $BACKUP_DIR -name "backup_*.sql" -mtime +7 -delete
EOF

chmod +x /var/www/manqiyou/backup.sh

# æ·»åŠ åˆ° crontabï¼ˆæ¯å¤©å‡Œæ™¨ 2 ç‚¹å¤‡ä»½ï¼‰
(crontab -l 2>/dev/null; echo "0 2 * * * /var/www/manqiyou/backup.sh") | crontab -
```

### 8.5 æ¢å¤æ•°æ®åº“

```bash
# æ¢å¤æ•°æ®åº“
docker exec -i manqiyou-postgres psql -U manqiyou_user manqiyou < /var/www/manqiyou/backups/backup_YYYYMMDD_HHMMSS.sql
```

---

## ğŸ›¡ï¸ ç¬¬ä¹é˜¶æ®µï¼šå®‰å…¨åŠ å›º

### 9.1 é…ç½®é˜²ç«å¢™

```bash
# å®‰è£… UFW
sudo apt install -y ufw

# å…è®¸ SSHï¼ˆé‡è¦ï¼ï¼‰
sudo ufw allow OpenSSH

# å…è®¸ HTTP å’Œ HTTPS
sudo ufw allow 'Nginx Full'

# å¯ç”¨é˜²ç«å¢™
sudo ufw enable

# æŸ¥çœ‹çŠ¶æ€
sudo ufw status verbose
```

### 9.2 é…ç½® Fail2ban

```bash
# å®‰è£… Fail2ban
sudo apt install -y fail2ban

# åˆ›å»ºæœ¬åœ°é…ç½®
sudo cp /etc/fail2ban/jail.conf /etc/fail2ban/jail.local

# ç¼–è¾‘é…ç½®
sudo nano /etc/fail2ban/jail.local

# å¯ç”¨ Nginx ä¿æŠ¤
[nginx-http-auth]
enabled = true

[nginx-noscript]
enabled = true

[nginx-badbots]
enabled = true

# å¯åŠ¨æœåŠ¡
sudo systemctl enable fail2ban
sudo systemctl start fail2ban

# æŸ¥çœ‹çŠ¶æ€
sudo fail2ban-client status
```

### 9.3 å®šæœŸæ›´æ–°ç³»ç»Ÿ

```bash
# åˆ›å»ºè‡ªåŠ¨æ›´æ–°è„šæœ¬
sudo apt install -y unattended-upgrades

# é…ç½®è‡ªåŠ¨æ›´æ–°
sudo dpkg-reconfigure -plow unattended-upgrades
```

---

## ğŸ“‹ æ•…éšœæ’æŸ¥

### é—®é¢˜ 1: å®¹å™¨æ— æ³•å¯åŠ¨

```bash
# æŸ¥çœ‹å®¹å™¨æ—¥å¿—
docker-compose -f docker-compose.prod.yml logs

# æ£€æŸ¥ç«¯å£å ç”¨
sudo netstat -tulpn | grep -E ':(3000|8080|5432|6379)'

# æ£€æŸ¥ Docker çŠ¶æ€
sudo systemctl status docker

# é‡å¯ Docker
sudo systemctl restart docker
```

### é—®é¢˜ 2: Nginx 502 Bad Gateway

```bash
# æ£€æŸ¥åç«¯æœåŠ¡æ˜¯å¦è¿è¡Œ
curl http://localhost:8080/api/health

# æ£€æŸ¥ Nginx é”™è¯¯æ—¥å¿—
sudo tail -f /var/log/nginx/manqiyou_error.log

# æ£€æŸ¥ SELinuxï¼ˆå¦‚æœå¯ç”¨ï¼‰
sudo setenforce 0  # ä¸´æ—¶ç¦ç”¨æµ‹è¯•
```

### é—®é¢˜ 3: SSL è¯ä¹¦é—®é¢˜

```bash
# æ£€æŸ¥è¯ä¹¦çŠ¶æ€
sudo certbot certificates

# æ‰‹åŠ¨ç»­æœŸ
sudo certbot renew --force-renewal

# é‡æ–°è·å–è¯ä¹¦
sudo certbot delete --cert-name www.manqiyou.cn
sudo ./deploy/setup-ssl.sh
```

### é—®é¢˜ 4: æ•°æ®åº“è¿æ¥å¤±è´¥

```bash
# æ£€æŸ¥ PostgreSQL å®¹å™¨
docker exec -it manqiyou-postgres psql -U manqiyou_user -d manqiyou

# æ£€æŸ¥ç¯å¢ƒå˜é‡
docker exec manqiyou-backend env | grep DB_

# é‡å¯æ•°æ®åº“
docker-compose -f docker-compose.prod.yml restart postgres
```

---

## ğŸ“ è”ç³»å’Œæ”¯æŒ

### æœ‰ç”¨çš„å‘½ä»¤é€ŸæŸ¥

```bash
# æŸ¥çœ‹æ‰€æœ‰å®¹å™¨çŠ¶æ€
docker-compose -f docker-compose.prod.yml ps

# æŸ¥çœ‹å®æ—¶æ—¥å¿—
docker-compose -f docker-compose.prod.yml logs -f

# é‡å¯æ‰€æœ‰æœåŠ¡
docker-compose -f docker-compose.prod.yml restart

# æ›´æ–°å¹¶é‡å¯
cd /var/www/manqiyou && git pull && docker-compose -f docker-compose.prod.yml up -d --build

# æŸ¥çœ‹ Nginx çŠ¶æ€
sudo systemctl status nginx

# é‡è½½ Nginx é…ç½®
sudo nginx -t && sudo systemctl reload nginx

# æŸ¥çœ‹ SSL è¯ä¹¦
sudo certbot certificates

# æŸ¥çœ‹ç³»ç»Ÿèµ„æº
docker stats
htop
```

---

## âœ… éƒ¨ç½²æ£€æŸ¥æ¸…å•

### éƒ¨ç½²å‰
- [ ] ä»£ç å·²æ¨é€åˆ° GitHub
- [ ] ç¯å¢ƒå˜é‡å·²é…ç½®
- [ ] Docker å’Œ Docker Compose å·²å®‰è£…
- [ ] åŸŸå DNS å·²è§£æåˆ°æœåŠ¡å™¨ IP
- [ ] SSH å¯†é’¥å·²é…ç½®

### éƒ¨ç½²ä¸­
- [ ] ä»£ç å·²å…‹éš†åˆ°æœåŠ¡å™¨
- [ ] ç¯å¢ƒå˜é‡å·²è®¾ç½®
- [ ] Docker å®¹å™¨å·²æ„å»ºå¹¶è¿è¡Œ
- [ ] Nginx é…ç½®å·²åˆ›å»º
- [ ] SSL è¯ä¹¦å·²è·å–
- [ ] HTTPS å·²å¯ç”¨

### éƒ¨ç½²å
- [ ] æ‰€æœ‰é¡µé¢å¯æ­£å¸¸è®¿é—®
- [ ] API æ¥å£æ­£å¸¸å·¥ä½œ
- [ ] å›¾ç‰‡å’Œé™æ€èµ„æºæ­£å¸¸åŠ è½½
- [ ] HTTPS æ­£å¸¸å·¥ä½œ
- [ ] è‡ªåŠ¨ç»­æœŸå·²é…ç½®
- [ ] æ—¥å¿—è½®è½¬å·²é…ç½®
- [ ] æ•°æ®åº“å¤‡ä»½å·²é…ç½®
- [ ] é˜²ç«å¢™å·²é…ç½®
- [ ] ç›‘æ§å·²è®¾ç½®

---

## ğŸ‰ éƒ¨ç½²å®Œæˆ

æ­å–œï¼æ¼«éª‘æ¸¸é¡¹ç›®å·²æˆåŠŸéƒ¨ç½²åˆ°é˜¿é‡Œäº‘æœåŠ¡å™¨ã€‚

**è®¿é—®åœ°å€**: https://www.manqiyou.cn

**ä¸‹ä¸€æ­¥å»ºè®®**:
1. é…ç½® CDN åŠ é€Ÿï¼ˆé˜¿é‡Œäº‘ CDNï¼‰
2. é…ç½®æ•°æ®åº“å®šæœŸå¤‡ä»½
3. è®¾ç½®ç›‘æ§å‘Šè­¦ï¼ˆé˜¿é‡Œäº‘äº‘ç›‘æ§ï¼‰
4. ä¼˜åŒ–å›¾ç‰‡åŠ è½½ï¼ˆä½¿ç”¨ WebP æ ¼å¼ï¼‰
5. é…ç½® Redis æŒä¹…åŒ–

**æŠ€æœ¯æ”¯æŒ**:
- æŸ¥çœ‹æ—¥å¿—: `docker-compose -f docker-compose.prod.yml logs -f`
- é‡å¯æœåŠ¡: `docker-compose -f docker-compose.prod.yml restart`
- æ›´æ–°ä»£ç : `cd /var/www/manqiyou && git pull && docker-compose -f docker-compose.prod.yml up -d --build`

---

**æ–‡æ¡£ç‰ˆæœ¬**: 1.0
**æœ€åæ›´æ–°**: 2025-01-29
