# 端口配置速查表

## 🎯 快速配置（复制粘贴）

### 阿里云安全组 - 必需开放的端口

```
端口 22  - SSH    - 授权对象: 0.0.0.0/0 (或你的IP)
端口 80  - HTTP   - 授权对象: 0.0.0.0/0
端口 443 - HTTPS  - 授权对象: 0.0.0.0/0
```

### 服务器 UFW 防火墙配置

```bash
sudo ufw allow 22/tcp
sudo ufw allow 80/tcp
sudo ufw allow 443/tcp
sudo ufw enable
```

---

## 📊 端口架构图

```
┌─────────────────────────────────────────────────────────────┐
│                        Internet                             │
│                     (公网访问)                               │
└────────────────────┬────────────────────────────────────────┘
                     │
                     │ 需要开放的端口
                     │
        ┌────────────┼────────────┐
        │            │            │
        ▼            ▼            ▼
     端口 22       端口 80      端口 443
      (SSH)       (HTTP)       (HTTPS)
        │            │            │
        │            └────┬───────┘
        │                 │
        ▼                 ▼
┌─────────────────────────────────────────────────────────────┐
│              阿里云安全组 + UFW 防火墙                        │
│                    (第一层防护)                              │
└────────────────────┬────────────────────────────────────────┘
                     │
                     ▼
┌─────────────────────────────────────────────────────────────┐
│                   Ubuntu 服务器                              │
│                                                              │
│  ┌──────────────────────────────────────────────────────┐  │
│  │              Nginx (反向代理)                         │  │
│  │         监听: 80 (HTTP) + 443 (HTTPS)                │  │
│  └────────────────┬─────────────────────────────────────┘  │
│                   │                                         │
│         ┌─────────┴─────────┐                              │
│         │                   │                              │
│         ▼                   ▼                              │
│  ┌─────────────┐     ┌─────────────┐                      │
│  │  Next.js    │     │ Spring Boot │                      │
│  │  前端服务    │     │  后端服务    │                      │
│  │  端口: 3000 │     │  端口: 8080 │                      │
│  │  (内部访问) │     │  (内部访问) │                      │
│  │  127.0.0.1  │     │  127.0.0.1  │                      │
│  └─────────────┘     └──────┬──────┘                      │
│                              │                              │
│                              ▼                              │
│                       ┌─────────────┐                      │
│                       │ H2 Database │                      │
│                       │  (内部访问)  │                      │
│                       └─────────────┘                      │
└─────────────────────────────────────────────────────────────┘

图例：
✅ 需要开放 - 22, 80, 443
❌ 不要开放 - 3000, 8080, 5432, 6379
```

---

## 📋 端口详细说明

### 对外开放端口（必需）

| 端口 | 服务 | 用途 | 是否必需 | 安全建议 |
|------|------|------|----------|----------|
| **22** | SSH | 远程管理服务器 | ✅ 必需 | 限制访问 IP |
| **80** | HTTP | 网站访问（跳转到 HTTPS） | ✅ 必需 | 自动跳转 443 |
| **443** | HTTPS | 网站安全访问 | ✅ 必需 | 使用 SSL 证书 |

### 内部端口（不开放）

| 端口 | 服务 | 用途 | 监听地址 | 访问方式 |
|------|------|------|----------|----------|
| **3000** | Next.js | 前端应用 | 127.0.0.1 | 通过 Nginx 代理 |
| **8080** | Spring Boot | 后端 API | 127.0.0.1 | 通过 Nginx 代理 |
| **5432** | PostgreSQL | 数据库 | 127.0.0.1 | 应用内部连接 |
| **6379** | Redis | 缓存 | 127.0.0.1 | 应用内部连接 |

---

## 🔧 配置命令速查

### 阿里云控制台配置

1. 登录 [ECS 控制台](https://ecs.console.aliyun.com/)
2. 实例 → 安全组 → 配置规则 → 入方向
3. 快速添加：SSH(22) + HTTP(80) + HTTPS(443)

### 服务器命令配置

```bash
# 1. 配置 UFW 防火墙
sudo ufw allow 22/tcp    # SSH
sudo ufw allow 80/tcp    # HTTP
sudo ufw allow 443/tcp   # HTTPS
sudo ufw enable          # 启用防火墙

# 2. 查看防火墙状态
sudo ufw status verbose

# 3. 查看监听端口
sudo netstat -tulpn | grep LISTEN

# 4. 测试端口（从服务器内部）
curl http://localhost:80
curl http://localhost:3000
curl http://localhost:8080
```

---

## ✅ 配置验证

### 1. 检查阿里云安全组

```
登录阿里云控制台 → ECS → 安全组 → 查看规则

应该看到：
✅ 22/22   TCP  0.0.0.0/0  允许
✅ 80/80   TCP  0.0.0.0/0  允许
✅ 443/443 TCP  0.0.0.0/0  允许
```

### 2. 检查服务器防火墙

```bash
sudo ufw status

应该看到：
Status: active

To                         Action      From
--                         ------      ----
22/tcp                     ALLOW       Anywhere
80/tcp                     ALLOW       Anywhere
443/tcp                    ALLOW       Anywhere
```

### 3. 检查服务监听

```bash
sudo netstat -tulpn | grep LISTEN

应该看到：
tcp  0.0.0.0:22    LISTEN  (sshd)
tcp  0.0.0.0:80    LISTEN  (nginx)
tcp  0.0.0.0:443   LISTEN  (nginx)
tcp  127.0.0.1:3000  LISTEN  (node)
tcp  127.0.0.1:8080  LISTEN  (java)
```

注意：3000 和 8080 应该只监听 127.0.0.1，不是 0.0.0.0

### 4. 外部测试

```bash
# 从本地电脑测试
telnet your-server-ip 22   # 应该连接成功
telnet your-server-ip 80   # 应该连接成功
telnet your-server-ip 443  # 应该连接成功
telnet your-server-ip 3000 # 应该连接失败（超时）
telnet your-server-ip 8080 # 应该连接失败（超时）
```

---

## 🚨 安全警告

### ❌ 错误配置示例

**不要这样配置**：

```bash
# ❌ 错误：开放所有端口
sudo ufw allow from any to any

# ❌ 错误：开放前端端口
sudo ufw allow 3000/tcp

# ❌ 错误：开放后端端口
sudo ufw allow 8080/tcp

# ❌ 错误：开放数据库端口
sudo ufw allow 5432/tcp
```

### ✅ 正确配置示例

```bash
# ✅ 正确：只开放必需端口
sudo ufw default deny incoming
sudo ufw default allow outgoing
sudo ufw allow 22/tcp
sudo ufw allow 80/tcp
sudo ufw allow 443/tcp
sudo ufw enable
```

---

## 🔒 安全加固建议

### 1. SSH 安全

```bash
# 限制 SSH 访问 IP（推荐）
sudo ufw delete allow 22/tcp
sudo ufw allow from 你的IP to any port 22

# 或修改 SSH 端口
sudo nano /etc/ssh/sshd_config
# 修改: Port 2222
sudo systemctl restart sshd
sudo ufw allow 2222/tcp
```

### 2. 安装 Fail2ban

```bash
# 防止暴力破解
sudo apt install fail2ban
sudo systemctl enable fail2ban
sudo systemctl start fail2ban
```

### 3. 定期检查

```bash
# 每周检查开放端口
sudo ufw status
sudo netstat -tulpn | grep LISTEN

# 查看登录日志
sudo tail -f /var/log/auth.log
```

---

## 📞 故障排查

### 问题 1: SSH 无法连接

```bash
# 检查安全组
阿里云控制台 → 安全组 → 确认 22 端口已开放

# 检查防火墙
sudo ufw status | grep 22

# 检查 SSH 服务
sudo systemctl status sshd
```

### 问题 2: 网站无法访问

```bash
# 检查 80/443 端口
sudo ufw status | grep -E '80|443'

# 检查 Nginx
sudo systemctl status nginx
sudo nginx -t

# 检查监听
sudo netstat -tulpn | grep nginx
```

### 问题 3: API 返回 502

```bash
# 检查后端服务
sudo systemctl status manqiyou-backend

# 检查端口监听
sudo netstat -tulpn | grep 8080

# 应该看到 127.0.0.1:8080，不是 0.0.0.0:8080
```

---

## 📚 相关文档

- [阿里云安全组配置.md](阿里云安全组配置.md) - 详细配置指南
- [DEPLOYMENT.md](../DEPLOYMENT.md) - 完整部署文档
- [QUICK-START.md](QUICK-START.md) - 快速开始

---

## 🎯 总结

**记住这三个端口**：
- ✅ **22** - SSH 管理
- ✅ **80** - HTTP 访问
- ✅ **443** - HTTPS 访问

**不要开放这些端口**：
- ❌ **3000** - 前端（通过 Nginx 代理）
- ❌ **8080** - 后端（通过 Nginx 代理）
- ❌ **5432** - 数据库（内部访问）
- ❌ **6379** - Redis（内部访问）

**安全原则**：
1. 只开放必需的端口
2. 使用防火墙双重防护（安全组 + UFW）
3. 定期检查和更新
4. 使用 SSH 密钥登录
5. 限制 SSH 访问 IP

---

**配置完成后，记得验证！** ✅
