# éƒ¨ç½²æ–‡ä»¶è¯´æ˜

## ğŸ“ æ–°åˆ›å»ºçš„éƒ¨ç½²æ–‡ä»¶æ¸…å•

æœ¬æ¬¡ä¸ºé˜¿é‡Œäº‘éƒ¨ç½²åˆ›å»ºäº†ä»¥ä¸‹æ–‡ä»¶ï¼š

### 1. Docker é…ç½®æ–‡ä»¶

#### `docker-compose.prod.yml` (é¡¹ç›®æ ¹ç›®å½•)
**ç”¨é€”**: ç”Ÿäº§ç¯å¢ƒ Docker Compose é…ç½®æ–‡ä»¶
**å†…å®¹**:
- PostgreSQL æ•°æ®åº“å®¹å™¨é…ç½®
- Redis ç¼“å­˜å®¹å™¨é…ç½®
- Spring Boot åç«¯å®¹å™¨é…ç½®
- Next.js å‰ç«¯å®¹å™¨é…ç½®
- ç½‘ç»œå’Œæ•°æ®å·é…ç½®
- å¥åº·æ£€æŸ¥é…ç½®

**ä½¿ç”¨æ–¹æ³•**:
```bash
docker-compose -f docker-compose.prod.yml up -d --build
```

#### `backend/manqiyou-app/Dockerfile`
**ç”¨é€”**: åç«¯ Docker é•œåƒæ„å»ºæ–‡ä»¶
**ç‰¹ç‚¹**:
- å¤šé˜¶æ®µæ„å»ºï¼ˆæ„å»ºé˜¶æ®µ + è¿è¡Œé˜¶æ®µï¼‰
- ä½¿ç”¨ Maven æ„å»º JAR åŒ…
- åŸºäº Eclipse Temurin JRE 17
- é root ç”¨æˆ·è¿è¡Œ
- åŒ…å«å¥åº·æ£€æŸ¥

#### `frontend/Dockerfile`
**ç”¨é€”**: å‰ç«¯ Docker é•œåƒæ„å»ºæ–‡ä»¶
**ç‰¹ç‚¹**:
- å¤šé˜¶æ®µæ„å»ºï¼ˆä¾èµ– + æ„å»º + è¿è¡Œï¼‰
- Next.js standalone è¾“å‡º
- åŸºäº Node.js 20 Alpine
- é root ç”¨æˆ·è¿è¡Œ
- åŒ…å«å¥åº·æ£€æŸ¥

---

### 2. ç¯å¢ƒé…ç½®æ–‡ä»¶

#### `.env.production` (é¡¹ç›®æ ¹ç›®å½•)
**ç”¨é€”**: ç”Ÿäº§ç¯å¢ƒå˜é‡æ¨¡æ¿
**åŒ…å«**:
- æ•°æ®åº“å¯†ç 
- Redis å¯†ç 
- JWT å¯†é’¥
- API URL

**æ³¨æ„**: éƒ¨ç½²æ—¶éœ€è¦ä¿®æ”¹å¯†ç å’Œå¯†é’¥ï¼

---

### 3. Nginx é…ç½®æ–‡ä»¶

#### `deploy/nginx-manqiyou.conf`
**ç”¨é€”**: Nginx åå‘ä»£ç†é…ç½®
**åŠŸèƒ½**:
- HTTP åˆ° HTTPS é‡å®šå‘
- SSL/TLS é…ç½®
- å‰ç«¯åå‘ä»£ç†ï¼ˆç«¯å£ 3000ï¼‰
- åç«¯ API åå‘ä»£ç†ï¼ˆç«¯å£ 8080ï¼‰
- é™æ€èµ„æºç¼“å­˜
- Gzip å‹ç¼©
- å®‰å…¨å“åº”å¤´
- CORS é…ç½®

**éƒ¨ç½²ä½ç½®**: `/etc/nginx/sites-available/manqiyou`

---

### 4. éƒ¨ç½²è„šæœ¬

#### `deploy/quick-deploy.sh`
**ç”¨é€”**: ä¸€é”®éƒ¨ç½²è„šæœ¬
**åŠŸèƒ½**:
- æ£€æŸ¥ç¯å¢ƒä¾èµ–
- åˆ›å»ºé¡¹ç›®ç›®å½•
- å…‹éš†æˆ–æ›´æ–°ä»£ç 
- é…ç½®ç¯å¢ƒå˜é‡
- æ„å»ºå¹¶å¯åŠ¨ Docker å®¹å™¨
- éªŒè¯æœåŠ¡çŠ¶æ€

**ä½¿ç”¨æ–¹æ³•**:
```bash
bash deploy/quick-deploy.sh
```

#### `deploy/setup-ssl.sh`
**ç”¨é€”**: SSL è¯ä¹¦é…ç½®è„šæœ¬
**åŠŸèƒ½**:
- å®‰è£… Certbot
- è·å– Let's Encrypt è¯ä¹¦
- é…ç½®è‡ªåŠ¨ç»­æœŸ
- æµ‹è¯•ç»­æœŸåŠŸèƒ½

**ä½¿ç”¨æ–¹æ³•**:
```bash
sudo bash deploy/setup-ssl.sh
```

#### `deploy/deploy-to-aliyun.sh`
**ç”¨é€”**: å®Œæ•´éƒ¨ç½²è„šæœ¬ï¼ˆåŒ…å«æ›´å¤šæ£€æŸ¥ï¼‰
**åŠŸèƒ½**:
- ä¸ quick-deploy.sh ç±»ä¼¼
- å¢åŠ äº†æ›´å¤šéªŒè¯æ­¥éª¤
- æ›´è¯¦ç»†çš„è¾“å‡ºä¿¡æ¯

---

### 5. æ–‡æ¡£æ–‡ä»¶

#### `deploy/é˜¿é‡Œäº‘éƒ¨ç½²å®Œæ•´æ–¹æ¡ˆ.md`
**ç”¨é€”**: å®Œæ•´çš„éƒ¨ç½²æŒ‡å—
**å†…å®¹**:
- é¡¹ç›®æ¦‚å†µ
- éƒ¨ç½²æ¶æ„
- è¯¦ç»†çš„åˆ†æ­¥éƒ¨ç½²æµç¨‹ï¼ˆ9 ä¸ªé˜¶æ®µï¼‰
- æ—¥å¸¸è¿ç»´å‘½ä»¤
- æ•…éšœæ’æŸ¥æŒ‡å—
- å®‰å…¨åŠ å›ºå»ºè®®

**è¿™æ˜¯æœ€é‡è¦çš„æ–‡æ¡£ï¼ŒåŒ…å«æ‰€æœ‰éƒ¨ç½²ç»†èŠ‚ï¼**

#### `deploy/README-ALIYUN.md`
**ç”¨é€”**: éƒ¨ç½²æ–‡æ¡£ç´¢å¼•
**å†…å®¹**:
- æ‰€æœ‰æ–‡æ¡£åˆ—è¡¨
- å¿«é€Ÿå¼€å§‹æŒ‡å—
- å¸¸ç”¨å‘½ä»¤é€ŸæŸ¥
- æ•…éšœæ’æŸ¥å¿«é€Ÿå‚è€ƒ

#### `deploy/DEPLOYMENT_CHECKLIST.md`
**ç”¨é€”**: éƒ¨ç½²æ£€æŸ¥æ¸…å•
**å†…å®¹**:
- éƒ¨ç½²å‰æ£€æŸ¥é¡¹
- éƒ¨ç½²æ­¥éª¤æ¸…å•
- éƒ¨ç½²åéªŒè¯æ¸…å•
- é…ç½®æ£€æŸ¥æ¸…å•
- éƒ¨ç½²å®Œæˆè®°å½•è¡¨

#### `PROJECT_SUMMARY.md` (é¡¹ç›®æ ¹ç›®å½•)
**ç”¨é€”**: é¡¹ç›®æ€»ç»“æ–‡æ¡£
**å†…å®¹**:
- é¡¹ç›®æ¦‚å†µ
- æ ¸å¿ƒåŠŸèƒ½
- æŠ€æœ¯æ¶æ„
- é¡¹ç›®ç»Ÿè®¡
- è®¾è®¡ç‰¹è‰²
- éƒ¨ç½²æ–¹æ¡ˆ
- ä¸‹ä¸€æ­¥è®¡åˆ’

#### `deploy/éƒ¨ç½²æ–‡ä»¶è¯´æ˜.md` (æœ¬æ–‡æ¡£)
**ç”¨é€”**: è¯´æ˜æ‰€æœ‰æ–°åˆ›å»ºçš„éƒ¨ç½²æ–‡ä»¶

---

## ğŸ“‹ æ–‡ä»¶ä½¿ç”¨æµç¨‹

### ç¬¬ä¸€æ­¥ï¼šå‡†å¤‡é˜¶æ®µ
1. é˜…è¯» `PROJECT_SUMMARY.md` äº†è§£é¡¹ç›®
2. é˜…è¯» `deploy/é˜¿é‡Œäº‘éƒ¨ç½²å®Œæ•´æ–¹æ¡ˆ.md` äº†è§£éƒ¨ç½²æµç¨‹
3. æ£€æŸ¥ `deploy/DEPLOYMENT_CHECKLIST.md` ç¡®ä¿å‡†å¤‡å°±ç»ª

### ç¬¬äºŒæ­¥ï¼šé…ç½®é˜¶æ®µ
1. ä¿®æ”¹ `.env.production` è®¾ç½®å¯†ç å’Œå¯†é’¥
2. æ£€æŸ¥ `docker-compose.prod.yml` é…ç½®
3. æ£€æŸ¥ `deploy/nginx-manqiyou.conf` é…ç½®

### ç¬¬ä¸‰æ­¥ï¼šéƒ¨ç½²é˜¶æ®µ
1. è¿è¡Œ `deploy/quick-deploy.sh` éƒ¨ç½²åº”ç”¨
2. é…ç½® Nginxï¼ˆå¤åˆ¶ nginx-manqiyou.confï¼‰
3. è¿è¡Œ `deploy/setup-ssl.sh` é…ç½® SSL

### ç¬¬å››æ­¥ï¼šéªŒè¯é˜¶æ®µ
1. ä½¿ç”¨ `deploy/DEPLOYMENT_CHECKLIST.md` é€é¡¹æ£€æŸ¥
2. æµ‹è¯•æ‰€æœ‰åŠŸèƒ½
3. è®°å½•éƒ¨ç½²ä¿¡æ¯

---

## ğŸ”§ é…ç½®æ–‡ä»¶ä¿®æ”¹æŒ‡å—

### å¿…é¡»ä¿®æ”¹çš„æ–‡ä»¶

#### 1. `.env.production`
```bash
# ä¿®æ”¹è¿™äº›å€¼ä¸ºå¼ºå¯†ç 
DB_PASSWORD=your_strong_password_here
REDIS_PASSWORD=your_strong_password_here
JWT_SECRET=$(openssl rand -base64 32)
```

#### 2. `deploy/setup-ssl.sh`
```bash
# ä¿®æ”¹é‚®ç®±åœ°å€
EMAIL="your-email@example.com"
```

### å¯é€‰ä¿®æ”¹çš„æ–‡ä»¶

#### 1. `docker-compose.prod.yml`
å¦‚æœéœ€è¦ä¿®æ”¹ç«¯å£æˆ–èµ„æºé™åˆ¶ï¼š
```yaml
services:
  frontend:
    ports:
      - "127.0.0.1:3001:3000"  # ä¿®æ”¹å¤–éƒ¨ç«¯å£
```

#### 2. `deploy/nginx-manqiyou.conf`
å¦‚æœéœ€è¦ä¿®æ”¹åŸŸåæˆ–æ·»åŠ å…¶ä»–é…ç½®ï¼š
```nginx
server_name your-domain.com www.your-domain.com;
```

---

## ğŸ“Š æ–‡ä»¶ä¾èµ–å…³ç³»

```
é˜¿é‡Œäº‘éƒ¨ç½²å®Œæ•´æ–¹æ¡ˆ.md (ä¸»æ–‡æ¡£)
    â”œâ”€â”€ docker-compose.prod.yml
    â”‚   â”œâ”€â”€ backend/manqiyou-app/Dockerfile
    â”‚   â”œâ”€â”€ frontend/Dockerfile
    â”‚   â””â”€â”€ .env.production
    â”‚
    â”œâ”€â”€ deploy/nginx-manqiyou.conf
    â”‚
    â”œâ”€â”€ deploy/quick-deploy.sh
    â”‚   â””â”€â”€ docker-compose.prod.yml
    â”‚
    â”œâ”€â”€ deploy/setup-ssl.sh
    â”‚
    â””â”€â”€ deploy/DEPLOYMENT_CHECKLIST.md
```

---

## âœ… æ–‡ä»¶å®Œæ•´æ€§æ£€æŸ¥

åœ¨éƒ¨ç½²å‰ï¼Œç¡®ä¿ä»¥ä¸‹æ–‡ä»¶éƒ½å­˜åœ¨ï¼š

### Docker ç›¸å…³
- [ ] `docker-compose.prod.yml`
- [ ] `backend/manqiyou-app/Dockerfile`
- [ ] `frontend/Dockerfile`
- [ ] `.env.production`

### Nginx ç›¸å…³
- [ ] `deploy/nginx-manqiyou.conf`

### è„šæœ¬æ–‡ä»¶
- [ ] `deploy/quick-deploy.sh`
- [ ] `deploy/setup-ssl.sh`
- [ ] `deploy/deploy-to-aliyun.sh`

### æ–‡æ¡£æ–‡ä»¶
- [ ] `deploy/é˜¿é‡Œäº‘éƒ¨ç½²å®Œæ•´æ–¹æ¡ˆ.md`
- [ ] `deploy/README-ALIYUN.md`
- [ ] `deploy/DEPLOYMENT_CHECKLIST.md`
- [ ] `PROJECT_SUMMARY.md`
- [ ] `deploy/éƒ¨ç½²æ–‡ä»¶è¯´æ˜.md` (æœ¬æ–‡æ¡£)

---

## ğŸš€ å¿«é€Ÿéƒ¨ç½²å‘½ä»¤

å¦‚æœæ‰€æœ‰æ–‡ä»¶éƒ½å·²å‡†å¤‡å¥½ï¼Œå¯ä»¥ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤å¿«é€Ÿéƒ¨ç½²ï¼š

```bash
# 1. è¿æ¥åˆ°æœåŠ¡å™¨
ssh root@47.37.21.33

# 2. å…‹éš†ä»£ç 
sudo mkdir -p /var/www/manqiyou
sudo chown -R $USER:$USER /var/www/manqiyou
cd /var/www/manqiyou
git clone git@github.com:zhf186/mqyweb.git .

# 3. é…ç½®ç¯å¢ƒå˜é‡
cp .env.production .env
nano .env  # ä¿®æ”¹å¯†ç 

# 4. è¿è¡Œéƒ¨ç½²è„šæœ¬
bash deploy/quick-deploy.sh

# 5. é…ç½® Nginx
sudo cp deploy/nginx-manqiyou.conf /etc/nginx/sites-available/manqiyou
sudo ln -s /etc/nginx/sites-available/manqiyou /etc/nginx/sites-enabled/
sudo nginx -t && sudo systemctl reload nginx

# 6. é…ç½® SSL
sudo nano deploy/setup-ssl.sh  # ä¿®æ”¹é‚®ç®±
sudo bash deploy/setup-ssl.sh

# 7. éªŒè¯éƒ¨ç½²
curl https://www.manqiyou.cn
```

---

## ğŸ“ è·å–å¸®åŠ©

å¦‚æœåœ¨éƒ¨ç½²è¿‡ç¨‹ä¸­é‡åˆ°é—®é¢˜ï¼š

1. **æŸ¥çœ‹æ—¥å¿—**:
   ```bash
   docker-compose -f docker-compose.prod.yml logs -f
   sudo tail -f /var/log/nginx/manqiyou_error.log
   ```

2. **å‚è€ƒæ–‡æ¡£**:
   - `deploy/é˜¿é‡Œäº‘éƒ¨ç½²å®Œæ•´æ–¹æ¡ˆ.md` - å®Œæ•´éƒ¨ç½²æŒ‡å—
   - `deploy/DEPLOYMENT_CHECKLIST.md` - æ£€æŸ¥æ¸…å•
   - `deploy/README-ALIYUN.md` - å¿«é€Ÿå‚è€ƒ

3. **å¸¸è§é—®é¢˜**:
   - å®¹å™¨æ— æ³•å¯åŠ¨ â†’ æ£€æŸ¥ç«¯å£å ç”¨å’Œç¯å¢ƒå˜é‡
   - Nginx 502 é”™è¯¯ â†’ æ£€æŸ¥åç«¯å®¹å™¨çŠ¶æ€
   - SSL è¯ä¹¦é—®é¢˜ â†’ æ£€æŸ¥åŸŸåè§£æå’Œ 80 ç«¯å£

---

## ğŸ‰ éƒ¨ç½²æˆåŠŸ

å½“æ‰€æœ‰æ–‡ä»¶éƒ½æ­£ç¡®é…ç½®å¹¶éƒ¨ç½²æˆåŠŸåï¼Œä½ åº”è¯¥èƒ½å¤Ÿï¼š

- âœ… é€šè¿‡ https://www.manqiyou.cn è®¿é—®ç½‘ç«™
- âœ… æ‰€æœ‰é¡µé¢æ­£å¸¸åŠ è½½
- âœ… API æ¥å£æ­£å¸¸å·¥ä½œ
- âœ… SSL è¯ä¹¦æœ‰æ•ˆ
- âœ… è‡ªåŠ¨ç»­æœŸå·²é…ç½®

**æ­å–œï¼æ¼«éª‘æ¸¸é¡¹ç›®å·²æˆåŠŸéƒ¨ç½²åˆ°é˜¿é‡Œäº‘ï¼**

---

**æ–‡æ¡£ç‰ˆæœ¬**: 1.0
**åˆ›å»ºæ—¥æœŸ**: 2025-01-29
**æœ€åæ›´æ–°**: 2025-01-29
