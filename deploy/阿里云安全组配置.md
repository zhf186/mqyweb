# 阿里云安全组配置指南

## 📋 需要开放的端口

### 必需端口（生产环境）

| 端口 | 协议 | 用途 | 授权对象 | 优先级 |
|------|------|------|----------|--------|
| **22** | TCP | SSH 远程登录 | 你的 IP 或 0.0.0.0/0 | 1 |
| **80** | TCP | HTTP 访问（自动跳转 HTTPS） | 0.0.0.0/0 | 1 |
| **443** | TCP | HTTPS 访问（网站主要访问） | 0.0.0.0/0 | 1 |

### 内部端口（不需要开放）

| 端口 | 协议 | 用途 | 说明 |
|------|------|------|------|
| 3000 | TCP | Next.js 前端 | 仅内部访问，通过 Nginx 代理 |
| 8080 | TCP | Spring Boot 后端 | 仅内部访问，通过 Nginx 代理 |
| 5432 | TCP | PostgreSQL 数据库 | 仅内部访问（如使用） |
| 6379 | TCP | Redis 缓存 | 仅内部访问（如使用） |

---

## 🔧 阿里云控制台配置步骤

### 方式一：通过 ECS 控制台配置

#### 步骤 1：进入安全组配置

1. 登录 [阿里云控制台](https://ecs.console.aliyun.com/)
2. 点击左侧菜单 **"实例与镜像"** → **"实例"**
3. 找到你的 ECS 实例，点击实例 ID
4. 点击 **"安全组"** 标签页
5. 点击安全组 ID 进入安全组详情
6. 点击 **"配置规则"** → **"入方向"**

#### 步骤 2：添加安全组规则

点击 **"手动添加"** 或 **"快速添加"**，添加以下规则：

**规则 1：SSH 访问**
```
协议类型：SSH(22)
端口范围：22/22
授权对象：0.0.0.0/0  （或你的固定 IP，更安全）
优先级：1
描述：SSH 远程登录
```

**规则 2：HTTP 访问**
```
协议类型：HTTP(80)
端口范围：80/80
授权对象：0.0.0.0/0
优先级：1
描述：HTTP 访问（跳转到 HTTPS）
```

**规则 3：HTTPS 访问**
```
协议类型：HTTPS(443)
端口范围：443/443
授权对象：0.0.0.0/0
优先级：1
描述：HTTPS 网站访问
```

#### 步骤 3：保存配置

点击 **"保存"** 按钮，规则立即生效。

---

### 方式二：快速添加（推荐）

阿里云提供了快速添加常用端口的功能：

1. 进入安全组配置页面
2. 点击 **"快速添加"**
3. 勾选以下选项：
   - ✅ SSH (22)
   - ✅ HTTP (80)
   - ✅ HTTPS (443)
4. 授权对象选择：**0.0.0.0/0**
5. 点击 **"确定"**

---

## 🔒 安全建议

### 1. SSH 端口安全加固

**方式 A：限制 SSH 访问 IP（推荐）**

如果你有固定 IP，建议只允许特定 IP 访问 SSH：

```
协议类型：SSH(22)
端口范围：22/22
授权对象：你的公网IP/32  （例如：123.45.67.89/32）
优先级：1
描述：仅允许特定 IP SSH 访问
```

**方式 B：修改 SSH 默认端口**

在服务器上修改 SSH 端口（例如改为 2222）：

```bash
# 编辑 SSH 配置
sudo nano /etc/ssh/sshd_config

# 修改端口
Port 2222

# 重启 SSH 服务
sudo systemctl restart sshd
```

然后在安全组中：
- 删除 22 端口规则
- 添加 2222 端口规则

### 2. 禁用不必要的端口

**确保以下端口不对外开放**：
- ❌ 3000 (Next.js)
- ❌ 8080 (Spring Boot)
- ❌ 5432 (PostgreSQL)
- ❌ 6379 (Redis)
- ❌ 3306 (MySQL)

这些端口应该只在服务器内部访问，通过 Nginx 反向代理对外提供服务。

### 3. 使用 SSH 密钥登录

禁用密码登录，只允许密钥登录：

```bash
# 编辑 SSH 配置
sudo nano /etc/ssh/sshd_config

# 修改以下配置
PasswordAuthentication no
PubkeyAuthentication yes

# 重启 SSH 服务
sudo systemctl restart sshd
```

---

## 🛡️ 服务器防火墙配置（UFW）

除了阿里云安全组，服务器内部也需要配置防火墙：

### 配置 UFW 防火墙

```bash
# 安装 UFW（Ubuntu 通常已安装）
sudo apt install ufw

# 设置默认规则（拒绝所有入站，允许所有出站）
sudo ufw default deny incoming
sudo ufw default allow outgoing

# 允许 SSH（重要！先配置这个，否则可能断开连接）
sudo ufw allow 22/tcp
# 或者限制特定 IP
# sudo ufw allow from 你的IP to any port 22

# 允许 HTTP 和 HTTPS
sudo ufw allow 80/tcp
sudo ufw allow 443/tcp

# 或者使用预定义规则
sudo ufw allow 'Nginx Full'
sudo ufw allow 'OpenSSH'

# 启用防火墙
sudo ufw enable

# 查看状态
sudo ufw status verbose
```

### 验证防火墙规则

```bash
sudo ufw status numbered
```

应该看到类似输出：
```
Status: active

     To                         Action      From
     --                         ------      ----
[ 1] 22/tcp                     ALLOW IN    Anywhere
[ 2] 80/tcp                     ALLOW IN    Anywhere
[ 3] 443/tcp                    ALLOW IN    Anywhere
[ 4] 22/tcp (v6)                ALLOW IN    Anywhere (v6)
[ 5] 80/tcp (v6)                ALLOW IN    Anywhere (v6)
[ 6] 443/tcp (v6)                ALLOW IN    Anywhere (v6)
```

---

## 🔍 验证端口配置

### 1. 检查阿里云安全组

在阿里云控制台查看安全组规则，确认：
- ✅ 22 端口已开放
- ✅ 80 端口已开放
- ✅ 443 端口已开放
- ❌ 3000 端口未开放
- ❌ 8080 端口未开放

### 2. 检查服务器防火墙

```bash
# 查看 UFW 状态
sudo ufw status

# 查看监听端口
sudo netstat -tulpn | grep LISTEN

# 或使用 ss 命令
sudo ss -tulpn | grep LISTEN
```

### 3. 测试端口连通性

**从外部测试（在本地电脑）**：

```bash
# 测试 SSH
telnet your-server-ip 22

# 测试 HTTP
curl -I http://your-domain.com

# 测试 HTTPS
curl -I https://your-domain.com

# 测试端口是否开放
nc -zv your-server-ip 80
nc -zv your-server-ip 443
```

**在线工具测试**：
- https://www.yougetsignal.com/tools/open-ports/
- https://ping.chinaz.com/

---

## 📊 完整的安全组配置示例

### 生产环境推荐配置

| 规则方向 | 协议类型 | 端口范围 | 授权对象 | 优先级 | 描述 |
|---------|---------|---------|---------|--------|------|
| 入方向 | SSH(22) | 22/22 | 你的IP/32 | 1 | SSH 管理（限制 IP） |
| 入方向 | HTTP(80) | 80/80 | 0.0.0.0/0 | 1 | HTTP 访问 |
| 入方向 | HTTPS(443) | 443/443 | 0.0.0.0/0 | 1 | HTTPS 访问 |
| 入方向 | ICMP | - | 0.0.0.0/0 | 100 | Ping 测试（可选） |

### 开发环境配置（临时）

如果需要临时开放其他端口进行调试：

| 规则方向 | 协议类型 | 端口范围 | 授权对象 | 优先级 | 描述 |
|---------|---------|---------|---------|--------|------|
| 入方向 | 自定义TCP | 3000/3000 | 你的IP/32 | 100 | 前端调试（临时） |
| 入方向 | 自定义TCP | 8080/8080 | 你的IP/32 | 100 | 后端调试（临时） |

**注意**：调试完成后立即删除这些规则！

---

## 🚨 常见问题

### Q1: 配置了安全组，但还是无法访问？

**检查清单**：
1. ✅ 阿里云安全组规则已添加
2. ✅ 服务器 UFW 防火墙已配置
3. ✅ Nginx 服务正在运行：`sudo systemctl status nginx`
4. ✅ 域名已正确解析到服务器 IP
5. ✅ 服务监听在正确的端口：`sudo netstat -tulpn | grep nginx`

### Q2: SSH 连接超时？

**可能原因**：
- 安全组未开放 22 端口
- UFW 防火墙阻止了 SSH
- SSH 服务未运行

**解决方法**：
```bash
# 通过阿里云控制台的 VNC 登录服务器
# 检查 SSH 服务
sudo systemctl status sshd

# 检查防火墙
sudo ufw status

# 临时禁用防火墙测试
sudo ufw disable
```

### Q3: 网站可以访问，但 API 返回 502？

**原因**：后端服务未启动或端口配置错误

**检查**：
```bash
# 检查后端服务
sudo systemctl status manqiyou-backend

# 检查端口监听
sudo netstat -tulpn | grep 8080

# 查看后端日志
sudo journalctl -u manqiyou-backend -n 50
```

### Q4: HTTPS 无法访问？

**检查清单**：
1. ✅ 443 端口已在安全组开放
2. ✅ SSL 证书已正确配置
3. ✅ Nginx 配置正确：`sudo nginx -t`
4. ✅ 域名已解析到服务器

---

## 📝 配置检查清单

部署前请确认：

- [ ] 阿里云安全组已配置
  - [ ] SSH (22) 已开放
  - [ ] HTTP (80) 已开放
  - [ ] HTTPS (443) 已开放
  - [ ] 内部端口（3000, 8080）未开放

- [ ] 服务器防火墙已配置
  - [ ] UFW 已安装并启用
  - [ ] 允许 22, 80, 443 端口
  - [ ] 默认拒绝其他入站连接

- [ ] 端口连通性已测试
  - [ ] SSH 可以连接
  - [ ] HTTP 可以访问
  - [ ] HTTPS 可以访问

- [ ] 安全加固已完成
  - [ ] SSH 密钥登录已配置
  - [ ] 密码登录已禁用（可选）
  - [ ] SSH 访问 IP 已限制（可选）

---

## 🔗 相关文档

- [阿里云安全组文档](https://help.aliyun.com/document_detail/25387.html)
- [UFW 防火墙配置](https://help.ubuntu.com/community/UFW)
- [Nginx 安全配置](https://nginx.org/en/docs/http/ngx_http_ssl_module.html)

---

## 📞 需要帮助？

如果遇到端口配置问题：

1. 检查阿里云安全组规则
2. 检查服务器 UFW 防火墙
3. 查看服务监听端口
4. 测试端口连通性
5. 查看服务日志

**记住**：安全第一！只开放必需的端口，定期检查安全配置。🔒
