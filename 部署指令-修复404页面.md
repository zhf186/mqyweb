# 部署指令 - 修复 404 页面错误

## 问题说明

浏览器控制台出现以下 404 错误：
```
GET https://manqiyou.cn/community/events?_rsc=1bcxv 404 (Not Found)
GET https://manqiyou.cn/goods/1?_rsc=2ckqr 404 (Not Found)
GET https://manqiyou.cn/goods/2?_rsc=2ckqr 404 (Not Found)
GET https://manqiyou.cn/goods/3?_rsc=2ckqr 404 (Not Found)
```

## 原因

这些页面尚未创建：
1. `/community/events` - 社群活动列表页
2. `/goods/[id]` - 商品详情页（动态路由）

## 已完成的修复

✅ 创建了 `frontend/src/app/community/events/page.tsx`
✅ 创建了 `frontend/src/app/goods/[id]/page.tsx`
✅ 修复了语法错误
✅ 代码已提交到 GitHub

## 服务器部署步骤

请在服务器上执行以下命令：

### 1. 拉取最新代码
```bash
ssh root@47.97.21.33
cd /opt/mqyweb
git pull origin main
```

### 2. 停止并删除旧的前端容器
```bash
docker-compose -f docker-compose.prod.yml stop frontend
docker-compose -f docker-compose.prod.yml rm -f frontend
```

### 3. 删除旧的前端镜像（可选）
```bash
docker images | grep mqyweb-frontend
# 如果有镜像，删除它
docker rmi <IMAGE_ID>
```

### 4. 重新构建前端（不使用缓存）
```bash
docker-compose -f docker-compose.prod.yml build --no-cache frontend
```

**注意**: 这个步骤需要约 5-10 分钟，会下载依赖并构建 Next.js 应用。

### 5. 启动新的前端容器
```bash
docker-compose -f docker-compose.prod.yml up -d frontend
```

### 6. 等待启动并查看日志
```bash
# 等待 30 秒
sleep 30

# 查看日志
docker-compose -f docker-compose.prod.yml logs --tail=50 frontend
```

### 7. 验证部署
```bash
# 检查容器状态
docker-compose -f docker-compose.prod.yml ps

# 测试页面是否可访问
curl -I https://www.manqiyou.cn/community/events
curl -I https://www.manqiyou.cn/goods/1
```

## 新增页面功能

### 1. 社群活动页面 (`/community/events`)
- 显示所有社群骑行活动
- 支持筛选：全部/即将开始/已结束
- 显示活动日期、地点、参与人数
- 响应式设计，支持移动端

### 2. 商品详情页面 (`/goods/[id]`)
- 显示商品详细信息
- 商品图片、名称、价格、描述
- 添加到购物车按钮（UI only）
- 相关商品推荐
- 返回商品列表按钮

## 预期结果

部署完成后：
- ✅ `/community/events` 页面可正常访问
- ✅ `/goods/1`, `/goods/2` 等商品详情页可正常访问
- ✅ 浏览器控制台不再有 404 错误
- ✅ Next.js 预加载功能正常工作

## 故障排查

### 如果构建失败
```bash
# 查看构建日志
docker-compose -f docker-compose.prod.yml logs frontend

# 检查 Node.js 版本
docker run --rm node:20-alpine node --version

# 清理 Docker 缓存
docker system prune -a
```

### 如果页面仍然 404
```bash
# 确认文件已拉取
ls -la /opt/mqyweb/frontend/src/app/community/events/
ls -la /opt/mqyweb/frontend/src/app/goods/[id]/

# 重新构建
docker-compose -f docker-compose.prod.yml build --no-cache frontend
docker-compose -f docker-compose.prod.yml up -d frontend
```

### 如果容器无法启动
```bash
# 查看详细日志
docker-compose -f docker-compose.prod.yml logs --tail=100 frontend

# 检查端口占用
netstat -tulpn | grep 3001

# 重启所有服务
docker-compose -f docker-compose.prod.yml restart
```

## 一键部署脚本

如果想要一键执行所有步骤，可以创建并运行以下脚本：

```bash
cat > /opt/mqyweb/deploy-frontend-fix.sh << 'EOF'
#!/bin/bash
set -e

echo "=== 开始部署前端修复 ==="

echo "1. 拉取最新代码..."
cd /opt/mqyweb
git pull origin main

echo "2. 停止并删除旧容器..."
docker-compose -f docker-compose.prod.yml stop frontend
docker-compose -f docker-compose.prod.yml rm -f frontend

echo "3. 重新构建前端..."
docker-compose -f docker-compose.prod.yml build --no-cache frontend

echo "4. 启动新容器..."
docker-compose -f docker-compose.prod.yml up -d frontend

echo "5. 等待启动..."
sleep 30

echo "6. 查看日志..."
docker-compose -f docker-compose.prod.yml logs --tail=50 frontend

echo "7. 检查状态..."
docker-compose -f docker-compose.prod.yml ps

echo "=== 部署完成 ==="
echo "请访问以下页面验证："
echo "  - https://www.manqiyou.cn/community/events"
echo "  - https://www.manqiyou.cn/goods/1"
EOF

chmod +x /opt/mqyweb/deploy-frontend-fix.sh
/opt/mqyweb/deploy-frontend-fix.sh
```

## 完成时间估计

- 拉取代码: 10 秒
- 停止容器: 10 秒
- 构建镜像: 5-10 分钟
- 启动容器: 30 秒
- **总计**: 约 6-11 分钟

## 相关文件

- `frontend/src/app/community/events/page.tsx` - 社群活动页面
- `frontend/src/app/goods/[id]/page.tsx` - 商品详情页面
- `frontend/src/app/goods/page.tsx` - 商品列表页（已存在）
- `frontend/src/app/community/page.tsx` - 社群首页（已存在）
