# CORS 重复头修复记录

**日期**: 2026-01-30  
**状态**: ✅ 已解决

## 问题描述

浏览器访问 https://www.manqiyou.cn/routes 时，API 请求失败，控制台报错：

```
The 'Access-Control-Allow-Origin' header contains multiple values 'https://manqiyou.cn, *', but only one is allowed.
```

## 根本原因

CORS 响应头被重复添加，导致 `Access-Control-Allow-Origin` 的值变成了 `'https://manqiyou.cn, *'` 而不是单一值。

经排查发现：
- Nginx 配置正确（未添加 CORS 头）
- 后端 Spring Boot 配置存在问题，可能导致头部重复

## 解决方案

### 代码修改

1. **CorsConfig.java** - 添加优先级和使用单例列表
   ```java
   @Configuration
   @Order(Ordered.HIGHEST_PRECEDENCE)  // 确保最先执行
   public class CorsConfig {
       @Bean
       public CorsFilter corsFilter() {
           // 使用 Collections.singletonList() 确保单一值
           config.setAllowedOrigins(Arrays.asList(
               "http://localhost:3000",
               "https://www.manqiyou.cn",
               "https://manqiyou.cn"
           ));
       }
   }
   ```

2. **application.yml** - 移除 CORS 配置
   - 删除了 `spring.web.cors` 配置段，避免与 Java 配置冲突

3. **SecurityConfig.java** - 确认 CORS 过滤器顺序
   - 保持 `.cors(withDefaults())` 配置

### 部署步骤

```bash
# 1. 提交代码
git add .
git commit -m "fix: 修复 CORS 重复头问题"
git push

# 2. 服务器更新
ssh root@47.97.21.33
cd /opt/mqyweb
git pull

# 3. 重新构建后端（不使用缓存）
docker-compose -f docker-compose.prod.yml build --no-cache backend

# 4. 删除旧容器并启动新容器
docker-compose -f docker-compose.prod.yml rm -f backend
docker-compose -f docker-compose.prod.yml up -d backend

# 5. 等待启动（约 30 秒）
sleep 30

# 6. 查看日志确认启动成功
docker-compose -f docker-compose.prod.yml logs --tail=50 backend
```

## 验证结果

### CORS 头测试

```bash
# 测试 www.manqiyou.cn
$ curl -I -H 'Origin: https://www.manqiyou.cn' https://www.manqiyou.cn/api/routes
HTTP/2 200
access-control-allow-origin: https://www.manqiyou.cn  ✅
access-control-allow-credentials: true
access-control-expose-headers: Authorization, Content-Type, X-Total-Count

# 测试 manqiyou.cn
$ curl -I -H 'Origin: https://manqiyou.cn' https://www.manqiyou.cn/api/routes
HTTP/2 200
access-control-allow-origin: https://manqiyou.cn  ✅
access-control-allow-credentials: true
```

### API 数据测试

```bash
$ curl -s -H 'Origin: https://www.manqiyou.cn' https://www.manqiyou.cn/api/routes
{
  "code": 200,
  "message": "success",
  "data": {
    "records": [
      {
        "id": 1,
        "name": "东钱湖环湖骑游",
        "nameEn": "Dongqian Lake Circuit",
        ...
      }
    ]
  }
}
```

✅ **所有测试通过！**

## 影响范围

- ✅ Routes 页面正常加载数据
- ✅ 所有 API 端点 CORS 正常
- ✅ 支持 www.manqiyou.cn 和 manqiyou.cn 两个域名
- ✅ 本地开发环境（localhost:3000）仍然可用

## 相关文件

- `backend/manqiyou-app/src/main/java/com/manqiyou/app/config/CorsConfig.java`
- `backend/manqiyou-app/src/main/java/com/manqiyou/app/config/SecurityConfig.java`
- `backend/manqiyou-app/src/main/resources/application.yml`
- `CORS重复头修复方案.md` - 详细修复方案文档

## 经验总结

1. **CORS 配置应该集中管理** - 只在一个地方配置（Java 或 YAML，不要两者都配）
2. **使用 @Order 确保执行顺序** - 避免过滤器顺序问题
3. **重新构建时使用 --no-cache** - 确保使用最新代码
4. **删除旧容器再启动** - 避免 Docker 缓存问题
5. **测试多个域名** - 确保所有允许的 origin 都工作正常
