# 网站性能优化方案

**日期**: 2026-01-30  
**目标**: 提升网站加载速度，特别是图片加载和 about 页面

## 已完成的优化

### 1. About 页面图片优化 ✅

#### 优化内容
- ✅ 将所有 `<img>` 标签替换为 Next.js `<Image>` 组件
- ✅ 添加图片懒加载（`loading="lazy"`）
- ✅ 配置响应式图片尺寸（`sizes` 属性）
- ✅ 优化图片质量设置（`quality=75-85`）
- ✅ Hero 图片使用 `priority` 优先加载

#### 优化效果
- **Hero 图片**: 使用 `priority` 立即加载，避免 LCP 延迟
- **工厂图片**: 懒加载，只在滚动到视口时加载
- **门店图片**: 懒加载，减少初始加载时间
- **CTA 背景图**: 懒加载，最后加载

#### 技术细节
```tsx
// Hero 图片 - 优先加载
<Image
  src="/brand_assets/page1_img1.jpeg"
  alt="关于漫骑游"
  fill
  priority
  className="object-cover"
  sizes="100vw"
  quality={85}
/>

// 其他图片 - 懒加载
<Image
  src={img}
  alt="智造基地"
  fill
  className="object-cover"
  sizes="(max-width: 768px) 100vw, 50vw"
  loading="lazy"
/>
```

### 2. Next.js 配置优化 ✅

#### 图片优化配置
```javascript
images: {
  formats: ['image/avif', 'image/webp'],  // 使用现代图片格式
  deviceSizes: [640, 750, 828, 1080, 1200, 1920, 2048, 3840],
  imageSizes: [16, 32, 48, 64, 96, 128, 256, 384],
  minimumCacheTTL: 31536000,  // 1年缓存
}
```

#### 性能优化配置
```javascript
experimental: {
  optimizePackageImports: ['lucide-react', 'framer-motion'],
  optimizeCss: true,  // CSS 优化
},
compress: true,  // 启用 gzip 压缩
swcMinify: true,  // 使用 SWC 压缩
```

#### 缓存控制
```javascript
async headers() {
  return [
    {
      source: '/brand_assets/:path*',
      headers: [
        {
          key: 'Cache-Control',
          value: 'public, max-age=31536000, immutable',
        },
      ],
    },
  ]
}
```

### 3. 创建优化图片组件 ✅

创建了 `OptimizedImageLazy` 组件，提供：
- 加载状态显示（骨架屏）
- 错误处理
- 平滑过渡动画
- 自动优化

## 待优化页面

### 需要优化的页面列表

1. **E-bike 页面** (`/ebike`)
   - 6 个 `<img>` 标签需要替换
   - Hero 图片、设计图片、画廊图片、模型图片

2. **Community 页面** (`/community`)
   - 3 个 `<img>` 标签需要替换
   - Hero 图片、活动图片、画廊图片

3. **Routes 详情页** (`/routes/[id]`)
   - 1 个 `<img>` 标签需要替换
   - Hero 图片

## 性能优化建议

### 1. 图片优化最佳实践

#### 使用 Next.js Image 组件
```tsx
import Image from 'next/image'

// ✅ 正确
<Image
  src="/path/to/image.jpg"
  alt="描述"
  fill
  sizes="(max-width: 768px) 100vw, 50vw"
  loading="lazy"
/>

// ❌ 错误
<img src="/path/to/image.jpg" alt="描述" />
```

#### 配置 sizes 属性
```tsx
// 全宽图片
sizes="100vw"

// 响应式图片
sizes="(max-width: 640px) 100vw, (max-width: 1024px) 50vw, 33vw"

// 固定宽度
sizes="400px"
```

#### 优先级设置
```tsx
// Hero 图片 - 立即加载
<Image priority />

// 首屏图片 - 立即加载
<Image priority />

// 其他图片 - 懒加载
<Image loading="lazy" />
```

### 2. 代码分割优化

#### 动态导入重组件
```tsx
import dynamic from 'next/dynamic'

// 懒加载 Framer Motion 组件
const MotionDiv = dynamic(() => 
  import('framer-motion').then(mod => mod.motion.div),
  { ssr: false }
)
```

#### 路由级代码分割
Next.js 自动按路由分割代码，无需额外配置。

### 3. 字体优化

#### 使用 next/font
```tsx
import { Inter } from 'next/font/google'

const inter = Inter({ 
  subsets: ['latin'],
  display: 'swap',  // 使用 font-display: swap
})
```

### 4. 预加载关键资源

#### 在 layout.tsx 中预加载
```tsx
<link rel="preload" href="/brand_assets/hero.jpg" as="image" />
<link rel="preconnect" href="https://fonts.googleapis.com" />
```

### 5. 减少 JavaScript 包大小

#### 移除未使用的依赖
```bash
npm run build -- --analyze  # 分析包大小
```

#### 使用 Tree Shaking
```tsx
// ✅ 正确 - 只导入需要的
import { motion } from 'framer-motion'

// ❌ 错误 - 导入整个库
import * as FramerMotion from 'framer-motion'
```

### 6. 服务端渲染优化

#### 使用 Server Components
```tsx
// app/page.tsx - 默认是 Server Component
export default function Page() {
  // 在服务端渲染，无需客户端 JavaScript
  return <div>...</div>
}
```

#### 只在需要时使用 Client Components
```tsx
'use client'  // 只在需要交互时添加

import { useState } from 'react'
```

### 7. 缓存策略

#### 静态资源缓存
```nginx
# Nginx 配置
location /brand_assets/ {
    expires 1y;
    add_header Cache-Control "public, immutable";
}
```

#### API 缓存
```tsx
// 使用 React Query 缓存
const { data } = useQuery({
  queryKey: ['routes'],
  queryFn: fetchRoutes,
  staleTime: 5 * 60 * 1000,  // 5分钟
})
```

## 性能指标目标

### 当前目标
- **LCP (Largest Contentful Paint)**: < 2.5s
- **FID (First Input Delay)**: < 100ms
- **CLS (Cumulative Layout Shift)**: < 0.1
- **FCP (First Contentful Paint)**: < 1.8s
- **TTI (Time to Interactive)**: < 3.8s

### 优化后预期
- **LCP**: < 2.0s (提升 20%)
- **FCP**: < 1.5s (提升 17%)
- **总加载时间**: 减少 30-40%

## 测试工具

### 1. Lighthouse
```bash
# Chrome DevTools > Lighthouse
# 或使用 CLI
npm install -g lighthouse
lighthouse https://www.manqiyou.cn --view
```

### 2. WebPageTest
访问: https://www.webpagetest.org/

### 3. Next.js 分析
```bash
npm run build
# 查看构建输出的包大小分析
```

## 部署优化

### 1. 启用 CDN
- 使用阿里云 CDN 加速静态资源
- 配置图片 CDN

### 2. 启用 HTTP/2
```nginx
listen 443 ssl http2;
```

### 3. 启用 Brotli 压缩
```nginx
brotli on;
brotli_types text/plain text/css application/json application/javascript;
```

### 4. 配置 Service Worker
```tsx
// 使用 next-pwa
import withPWA from 'next-pwa'

export default withPWA({
  dest: 'public',
  register: true,
  skipWaiting: true,
})
```

## 监控和分析

### 1. 性能监控
- 使用 Google Analytics 4
- 配置 Web Vitals 监控

### 2. 错误监控
- 使用 Sentry 监控错误
- 配置性能追踪

### 3. 用户体验监控
- 监控真实用户指标 (RUM)
- 分析用户行为

## 下一步行动

### 立即执行
1. ✅ 优化 about 页面图片
2. ⏳ 优化 ebike 页面图片
3. ⏳ 优化 community 页面图片
4. ⏳ 优化 routes 详情页图片

### 短期优化 (1-2周)
1. 实施代码分割
2. 优化字体加载
3. 配置 CDN
4. 启用 Brotli 压缩

### 长期优化 (1个月+)
1. 实施 Service Worker
2. 配置性能监控
3. 优化数据库查询
4. 实施渐进式图片加载

## 性能优化检查清单

### 图片优化
- [x] 使用 Next.js Image 组件
- [x] 配置图片懒加载
- [x] 设置响应式图片尺寸
- [x] 使用现代图片格式 (WebP/AVIF)
- [x] 配置图片缓存
- [ ] 压缩图片文件
- [ ] 使用 CDN 加速

### 代码优化
- [x] 启用代码压缩
- [x] 移除 console.log
- [x] 配置 Tree Shaking
- [ ] 实施代码分割
- [ ] 优化依赖包

### 缓存优化
- [x] 配置静态资源缓存
- [x] 设置图片缓存
- [ ] 配置 API 缓存
- [ ] 实施 Service Worker

### 服务器优化
- [x] 启用 gzip 压缩
- [x] 配置 HTTP/2
- [ ] 启用 Brotli 压缩
- [ ] 配置 CDN

## 参考资料

- [Next.js Image Optimization](https://nextjs.org/docs/app/building-your-application/optimizing/images)
- [Web Vitals](https://web.dev/vitals/)
- [Lighthouse Performance Scoring](https://web.dev/performance-scoring/)
- [Next.js Performance](https://nextjs.org/docs/app/building-your-application/optimizing)
