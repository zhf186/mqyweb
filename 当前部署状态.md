# 漫骑游项目 - 当前部署状态

**更新时间**: 2025-01-29  
**服务器 IP**: 47.97.21.33  
**域名**: www.manqiyou.cn

---

## ✅ 已完成的工作

### 1. 项目代码和配置
- ✅ 前端代码完成（Next.js 14）
- ✅ 后端代码完成（Spring Boot）
- ✅ Docker 配置完成
- ✅ Nginx 配置完成
- ✅ 环境变量配置完成（强密码已设置）
- ✅ 代码已推送到 GitHub

### 2. 服务器部署
- ✅ 项目目录：`/opt/mqyweb`
- ✅ Docker 容器全部运行正常：
  - manqiyou-backend (127.0.0.1:8081)
  - manqiyou-frontend (127.0.0.1:3001)
  - manqiyou-postgres (127.0.0.1:5432)
  - manqiyou-redis (127.0.0.1:6379)
- ✅ 端口配置避免冲突（绑定到 127.0.0.1）
- ✅ Nginx HTTP 配置成功
- ✅ HTTP 访问正常工作

### 3. 文档更新
- ✅ 所有文档中的服务器 IP 已更新为 47.97.21.33
- ✅ 创建了 SSL DNS 验证配置指南

---

## ⏳ 待完成的工作

### SSL 证书配置（最后一步）

**原因**：Certbot 的 webroot 验证方式失败，因为 Nginx 配置中已包含 HTTPS 配置但证书还不存在。

**解决方案**：使用 DNS 验证方式获取 SSL 证书。

---

## 🚀 下一步操作（SSL 证书配置）

### 方法：DNS 验证（推荐）

#### 步骤 1：在服务器上运行 Certbot

```bash
# 连接到服务器
ssh root@47.97.21.33

# 使用 DNS 验证方式
sudo certbot certonly --manual --preferred-challenges dns \
  -d www.manqiyou.cn \
  -d manqiyou.cn \
  --email 56742186@qq.com \
  --agree-tos
```

#### 步骤 2：添加 DNS TXT 记录

Certbot 会显示需要添加的 TXT 记录，例如：

```
Please deploy a DNS TXT record under the name:
_acme-challenge.www.manqiyou.cn

with the following value:
xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
```

**在阿里云 DNS 控制台添加**：
1. 访问：https://dns.console.aliyun.com/
2. 找到域名：manqiyou.cn
3. 点击"解析设置"
4. 添加 TXT 记录：
   - 记录类型：TXT
   - 主机记录：`_acme-challenge.www`
   - 记录值：粘贴 Certbot 显示的值
   - TTL：600
5. 点击"确认"

#### 步骤 3：验证 DNS 记录生效

等待 1-5 分钟，然后验证：

```bash
dig _acme-challenge.www.manqiyou.cn TXT +short
```

看到记录值后，在 Certbot 终端按 Enter 继续。

#### 步骤 4：重复步骤 2-3（第二个域名）

Certbot 会要求为 `manqiyou.cn` 添加另一条 TXT 记录：
- 主机记录：`_acme-challenge`
- 记录值：Certbot 显示的第二个值

#### 步骤 5：启用 HTTPS 配置

证书获取成功后：

```bash
# 复制完整配置
sudo cp /opt/mqyweb/deploy/nginx-manqiyou.conf /etc/nginx/sites-available/manqiyou

# 测试配置
sudo nginx -t

# 重载 Nginx
sudo systemctl reload nginx
```

#### 步骤 6：配置自动续期

```bash
# 创建续期钩子
sudo mkdir -p /etc/letsencrypt/renewal-hooks/deploy

sudo tee /etc/letsencrypt/renewal-hooks/deploy/reload-nginx.sh > /dev/null << 'EOF'
#!/bin/bash
systemctl reload nginx
EOF

sudo chmod +x /etc/letsencrypt/renewal-hooks/deploy/reload-nginx.sh

# 测试自动续期
sudo certbot renew --dry-run

# 启用自动续期
sudo systemctl enable certbot.timer
sudo systemctl start certbot.timer
```

#### 步骤 7：验证 HTTPS 访问

```bash
# 测试 HTTPS
curl -I https://www.manqiyou.cn
```

**在浏览器中访问**：https://www.manqiyou.cn

---

## 📋 详细指南

完整的 SSL 配置步骤请参考：
- **`deploy/ssl-dns-setup-guide.md`** - DNS 验证详细指南

---

## 🔍 当前服务状态

### Docker 容器

```bash
cd /opt/mqyweb
docker-compose -f docker-compose.prod.yml ps
```

**状态**：
- ✅ manqiyou-backend: Up (127.0.0.1:8081->8080)
- ✅ manqiyou-frontend: Up (127.0.0.1:3001->3000)
- ✅ manqiyou-postgres: Up healthy (127.0.0.1:5432->5432)
- ✅ manqiyou-redis: Up healthy (127.0.0.1:6379->6379)

### Nginx 配置

**当前配置**：HTTP only（临时配置）
**目标配置**：HTTP + HTTPS（完整配置）

**配置文件**：
- 当前：`/etc/nginx/sites-available/manqiyou`（HTTP only）
- 完整：`/opt/mqyweb/deploy/nginx-manqiyou.conf`（HTTP + HTTPS）

### 访问测试

```bash
# HTTP 访问（当前可用）
curl -I http://www.manqiyou.cn

# HTTPS 访问（待配置 SSL 后可用）
curl -I https://www.manqiyou.cn
```

---

## 🔧 常用管理命令

### 查看日志

```bash
# Docker 日志
cd /opt/mqyweb
docker-compose -f docker-compose.prod.yml logs -f

# 前端日志
docker-compose -f docker-compose.prod.yml logs -f frontend

# 后端日志
docker-compose -f docker-compose.prod.yml logs -f backend

# Nginx 日志
sudo tail -f /var/log/nginx/manqiyou_access.log
sudo tail -f /var/log/nginx/manqiyou_error.log
```

### 重启服务

```bash
cd /opt/mqyweb

# 重启所有服务
docker-compose -f docker-compose.prod.yml restart

# 重启特定服务
docker-compose -f docker-compose.prod.yml restart frontend
docker-compose -f docker-compose.prod.yml restart backend
```

### 更新代码

```bash
cd /opt/mqyweb

# 拉取最新代码
git pull origin main

# 重新构建并启动
docker-compose -f docker-compose.prod.yml up -d --build
```

---

## 📊 部署进度

| 阶段 | 状态 | 说明 |
|------|------|------|
| 1. 代码开发 | ✅ 完成 | 前端 + 后端代码完成 |
| 2. 配置文件 | ✅ 完成 | Docker + Nginx + 环境变量 |
| 3. Git 推送 | ✅ 完成 | 代码已推送到 GitHub |
| 4. 服务器部署 | ✅ 完成 | Docker 容器运行正常 |
| 5. Nginx 配置 | ✅ 完成 | HTTP 访问正常 |
| 6. SSL 证书 | ⏳ 进行中 | 需要使用 DNS 验证 |
| 7. HTTPS 配置 | ⏳ 待完成 | SSL 证书获取后启用 |
| 8. 最终验证 | ⏳ 待完成 | 全面测试 |

**总体进度**：75% 完成

---

## 🎯 预计完成时间

- **SSL 证书配置**：10-15 分钟
- **HTTPS 启用**：2-3 分钟
- **最终验证**：5 分钟

**总计**：约 20 分钟即可完成全部部署！

---

## 📞 需要帮助？

### 查看详细文档

- **SSL DNS 验证指南**：`deploy/ssl-dns-setup-guide.md`
- **完整部署流程**：`完整部署流程.md`
- **一键部署指南**：`一键部署指南.md`
- **阿里云部署方案**：`deploy/阿里云部署完整方案.md`

### 常见问题

1. **DNS 记录未生效**：等待 1-5 分钟，使用 `dig` 命令验证
2. **Certbot 验证失败**：检查 DNS 记录是否正确添加
3. **Nginx 配置失败**：确保证书文件存在
4. **HTTPS 访问失败**：检查防火墙和 Nginx 状态

---

## 🎉 部署成功标志

当看到以下结果时，表示部署完全成功：

1. ✅ 浏览器访问 https://www.manqiyou.cn 显示网站
2. ✅ 浏览器地址栏显示安全锁图标 🔒
3. ✅ 所有页面正常加载
4. ✅ 图片和资源正常显示
5. ✅ 中英文切换正常
6. ✅ 移动端响应式正常

---

**下一步**：按照上面的步骤配置 SSL 证书，完成最后的部署工作！

**参考文档**：`deploy/ssl-dns-setup-guide.md`
