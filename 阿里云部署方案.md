# 漫骑游项目 - 阿里云部署方案

## 📦 方案概述

本方案为漫骑游项目提供完整的阿里云 Ubuntu 24.04 服务器部署解决方案，包括：

- ✅ **自动化部署脚本** - 一键完成环境配置和项目部署
- ✅ **完整文档** - 从准备到上线的详细指南
- ✅ **Nginx 反向代理** - 支持多项目共存
- ✅ **SSL/HTTPS** - 自动配置 Let's Encrypt 证书
- ✅ **进程管理** - PM2 + systemd 确保服务稳定运行
- ✅ **日志监控** - 完善的日志管理和监控方案

---

## 📁 已创建的文件

### 核心文档（5个）

1. **DEPLOYMENT.md** - 完整部署文档
   - 位置：项目根目录
   - 内容：详细的分步部署指南，包含所有配置说明和故障排查

2. **deploy/QUICK-START.md** - 快速部署指南
   - 5分钟快速上手
   - 三种部署方式
   - 常见问题解答

3. **deploy/README.md** - 脚本使用说明
   - 所有脚本的详细说明
   - 参数和使用方法
   - 故障排查指南

4. **deploy/CHECKLIST.md** - 部署检查清单
   - 部署前准备检查
   - 分步骤验证
   - 部署后测试

5. **deploy/部署方案总结.md** - 方案总结
   - 架构说明
   - 配置文件位置
   - 运维命令

### 自动化脚本（5个）

1. **deploy/setup-server.sh** - 服务器环境配置
   - 安装 Node.js 20.x
   - 安装 Java 17
   - 安装 PM2、Nginx、Certbot
   - 配置防火墙

2. **deploy/deploy.sh** - 自动部署脚本
   - 构建前后端
   - 配置进程管理
   - 配置 Nginx 反向代理

3. **deploy/update.sh** - 快速更新脚本
   - 拉取最新代码
   - 重新构建
   - 重启服务

4. **deploy/ssl-setup.sh** - SSL 证书配置
   - 自动获取 Let's Encrypt 证书
   - 配置 HTTPS
   - 设置自动续期

5. **deploy/upload-to-server.ps1** - Windows 上传脚本
   - 从本地上传代码到服务器
   - 支持 rsync 或 SCP

---

## 🚀 三种部署方式

### 方式一：全自动部署（推荐，最快）

**适用场景**：首次部署，代码已在 Git 仓库

**步骤**：
```bash
# 1. SSH 登录服务器
ssh username@your-server-ip

# 2. 克隆代码
git clone <你的仓库地址> /var/www/manqiyou
cd /var/www/manqiyou

# 3. 运行环境配置（首次）
bash deploy/setup-server.sh

# 4. 运行部署脚本
bash deploy/deploy.sh
# 输入域名: manqiyou.com

# 5. 配置 SSL
bash deploy/ssl-setup.sh
# 输入域名和邮箱

# 完成！访问 https://your-domain.com
```

**时间**：10-15 分钟

---

### 方式二：从本地上传部署

**适用场景**：代码在本地，需要上传到服务器

**步骤**：

**在本地 Windows PowerShell：**
```powershell
cd D:\mrcweb1
.\deploy\upload-to-server.ps1 -ServerIP "1.2.3.4" -Username "ubuntu"
```

**在服务器上：**
```bash
ssh ubuntu@1.2.3.4
cd /var/www/manqiyou

# 运行部署脚本
bash deploy/setup-server.sh
bash deploy/deploy.sh
bash deploy/ssl-setup.sh
```

**时间**：15-20 分钟（取决于网络速度）

---

### 方式三：手动部署

**适用场景**：需要自定义配置，或自动化脚本遇到问题

**步骤**：参考 [DEPLOYMENT.md](DEPLOYMENT.md) 完整文档

**时间**：30-60 分钟

---

## 🏗️ 部署架构

```
Internet (HTTPS/HTTP)
         │
         ▼
    ┌─────────┐
    │  Nginx  │ (80/443)
    │ 反向代理 │
    └────┬────┘
         │
    ┌────┴────────────────┐
    │                     │
    ▼                     ▼
┌─────────┐         ┌─────────┐
│ Next.js │         │ Spring  │
│  :3000  │         │  Boot   │
│  (PM2)  │         │  :8080  │
│         │         │(systemd)│
└─────────┘         └────┬────┘
                         │
                         ▼
                    ┌─────────┐
                    │   H2    │
                    │Database │
                    └─────────┘
```

### 技术栈
- **前端**：Next.js 14 + React 18 + TypeScript
- **后端**：Spring Boot 3.2 + Java 17
- **数据库**：H2 (开发) / PostgreSQL (生产可选)
- **Web服务器**：Nginx
- **进程管理**：PM2 (前端) + systemd (后端)
- **SSL证书**：Let's Encrypt (免费)

---

## 📋 部署前准备

### 1. 服务器要求
- **系统**：Ubuntu 24.04 LTS
- **配置**：建议 2核4G 以上
- **端口**：需开放 22 (SSH), 80 (HTTP), 443 (HTTPS)
  - 📖 详细配置：[阿里云安全组配置.md](deploy/阿里云安全组配置.md)
  - ⚡ 速查表：[端口配置速查表.md](deploy/端口配置速查表.md)

### 2. 域名要求
- 已购买域名
- 已完成备案（中国大陆服务器）
- DNS 已解析到服务器 IP
  - A 记录：your-domain.com → 服务器IP
  - A 记录：www.your-domain.com → 服务器IP

### 3. 本地准备
- 项目代码已提交到 Git（方式一）
- 或准备好 SSH 上传工具（方式二）

---

## ⚡ 快速开始（推荐流程）

### 第一步：准备服务器

1. 登录阿里云控制台
2. 创建 ECS 实例（Ubuntu 24.04）
3. 配置安全组，开放端口：22, 80, 443
4. 获取服务器公网 IP

### 第二步：配置域名

1. 登录域名管理控制台
2. 添加 DNS 解析记录：
   - A 记录：@ → 服务器IP
   - A 记录：www → 服务器IP
3. 等待 DNS 生效（通常 10 分钟内）

### 第三步：上传代码

**方式 A：使用 Git（推荐）**
```bash
ssh username@your-server-ip
git clone <你的仓库地址> /var/www/manqiyou
```

**方式 B：从本地上传**
```powershell
# Windows PowerShell
cd D:\mrcweb1
.\deploy\upload-to-server.ps1 -ServerIP "your-ip" -Username "ubuntu"
```

### 第四步：运行部署脚本

```bash
cd /var/www/manqiyou

# 1. 配置环境（首次部署）
bash deploy/setup-server.sh

# 2. 部署项目
bash deploy/deploy.sh
# 输入域名: manqiyou.com

# 3. 配置 SSL
bash deploy/ssl-setup.sh
# 输入域名和邮箱
```

### 第五步：验证部署

1. 访问网站：https://your-domain.com
2. 检查服务状态：
   ```bash
   pm2 status
   sudo systemctl status manqiyou-backend
   ```
3. 查看日志：
   ```bash
   pm2 logs manqiyou-frontend
   sudo journalctl -u manqiyou-backend -f
   ```

---

## 🔧 日常运维

### 查看服务状态
```bash
# 前端
pm2 status
pm2 logs manqiyou-frontend

# 后端
sudo systemctl status manqiyou-backend
sudo journalctl -u manqiyou-backend -f

# Nginx
sudo systemctl status nginx
sudo tail -f /var/log/nginx/manqiyou_access.log
```

### 重启服务
```bash
# 前端
pm2 restart manqiyou-frontend

# 后端
sudo systemctl restart manqiyou-backend

# Nginx
sudo systemctl reload nginx
```

### 更新代码
```bash
cd /var/www/manqiyou
bash deploy/update.sh
```

### 查看日志
```bash
# 前端日志
pm2 logs manqiyou-frontend --lines 100

# 后端日志
sudo journalctl -u manqiyou-backend -n 100

# Nginx 访问日志
sudo tail -100 /var/log/nginx/manqiyou_access.log

# Nginx 错误日志
sudo tail -100 /var/log/nginx/manqiyou_error.log
```

---

## 🔒 安全建议

### 1. 服务器安全
- ✅ 使用 SSH 密钥登录
- ✅ 禁用 root 密码登录
- ✅ 配置防火墙（UFW）
- ✅ 安装 fail2ban 防暴力破解
- ✅ 定期更新系统

### 2. 应用安全
- ✅ 使用 HTTPS（Let's Encrypt）
- ✅ 配置安全响应头
- ✅ 限制上传文件大小
- ✅ 定期备份数据
- ✅ 使用强密码

### 3. 监控和日志
- ✅ 配置日志轮转
- ✅ 监控服务状态
- ✅ 设置告警通知
- ✅ 定期检查日志

---

## 🐛 常见问题

### 1. 网站无法访问
**检查项**：
- 服务是否运行：`pm2 status` 和 `sudo systemctl status manqiyou-backend`
- 防火墙规则：`sudo ufw status`
- 域名解析：`nslookup your-domain.com`
- Nginx 配置：`sudo nginx -t`

### 2. API 返回 502
**原因**：后端服务未启动或端口未监听

**解决**：
```bash
# 检查后端状态
sudo systemctl status manqiyou-backend

# 查看日志
sudo journalctl -u manqiyou-backend -n 50

# 重启后端
sudo systemctl restart manqiyou-backend
```

### 3. SSL 证书获取失败
**原因**：域名未解析或防火墙未开放 80 端口

**解决**：
```bash
# 检查域名解析
nslookup your-domain.com

# 检查防火墙
sudo ufw status

# 确保 Nginx 运行
sudo systemctl status nginx

# 重新获取证书
sudo certbot --nginx -d your-domain.com
```

### 4. 前端页面空白
**原因**：构建失败或环境变量配置错误

**解决**：
```bash
cd /var/www/manqiyou/frontend

# 检查环境变量
cat .env.production

# 重新构建
npm run build

# 重启前端
pm2 restart manqiyou-frontend
```

---

## 📚 文档索引

### 快速查找
- **首次部署**：[QUICK-START.md](deploy/QUICK-START.md)
- **详细步骤**：[DEPLOYMENT.md](DEPLOYMENT.md)
- **检查清单**：[CHECKLIST.md](deploy/CHECKLIST.md)
- **脚本说明**：[deploy/README.md](deploy/README.md)
- **架构说明**：[部署方案总结.md](deploy/部署方案总结.md)

### 按场景查找
- **环境配置**：DEPLOYMENT.md 第一步
- **代码上传**：DEPLOYMENT.md 第二步
- **构建部署**：DEPLOYMENT.md 第三步
- **SSL 配置**：DEPLOYMENT.md 第六步
- **故障排查**：DEPLOYMENT.md 故障排查章节
- **日常运维**：DEPLOYMENT.md 日常运维命令

---

## 💡 最佳实践

### 1. 部署流程
- 首次部署按顺序执行所有脚本
- 每一步完成后验证再继续
- 保存重要的配置信息

### 2. 代码更新
- 使用 `update.sh` 快速更新
- 重要更新前先备份
- 更新后检查日志

### 3. 监控维护
- 每天检查服务状态
- 每周查看错误日志
- 每月更新系统和依赖

### 4. 备份策略
- 定期备份数据库
- 备份重要配置文件
- 测试恢复流程

---

## 📞 获取帮助

### 遇到问题时
1. ✅ 查看对应的文档
2. ✅ 检查服务日志
3. ✅ 参考故障排查章节
4. ✅ 使用检查清单验证

### 文档位置
- 完整文档：`DEPLOYMENT.md`
- 快速指南：`deploy/QUICK-START.md`
- 检查清单：`deploy/CHECKLIST.md`
- 脚本说明：`deploy/README.md`

---

## ✅ 部署成功标志

部署成功后，你应该能够：

- ✅ 通过 HTTPS 访问网站
- ✅ HTTP 自动跳转到 HTTPS
- ✅ 首页和所有页面正常加载
- ✅ 图片和静态资源正常显示
- ✅ API 接口正常响应
- ✅ SSL 证书显示有效
- ✅ 所有服务状态正常
- ✅ 日志无错误信息

---

## 🎉 总结

本部署方案提供：

1. **完整的自动化脚本** - 10-15 分钟完成部署
2. **详细的文档** - 从准备到上线的完整指南
3. **灵活的部署方式** - 支持多种部署场景
4. **完善的运维工具** - 日志、监控、更新脚本
5. **安全可靠** - HTTPS、防火墙、进程管理

**现在就开始部署吧！** 🚀

按照 [QUICK-START.md](deploy/QUICK-START.md) 快速开始，或查看 [DEPLOYMENT.md](DEPLOYMENT.md) 了解详细步骤。
